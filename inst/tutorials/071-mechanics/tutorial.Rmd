---
title: Mechanics
author: David Kane and Gia Khang
tutorial:
  id: mechanics
output:
  learnr::tutorial:
    progressive: yes
    'allow_skip:': yes
runtime: shiny_prerendered
description: 'Chapter 7 Tutorial: Mechanics'
---

```{r setup, include = FALSE}
library(tidyverse)
library(primer.data)
library(brms)
library(broom.mixed)

knitr::opts_chunk$set(echo = FALSE)
options(tutorial.exercise.timelimit = 600, 
        tutorial.storage = "local") 
```

```{r copy-code-chunk, child = system.file("child_documents/copy_button.Rmd", package = "tutorial.helpers")}
```

```{r info-section, child = system.file("child_documents/info_section.Rmd", package = "tutorial.helpers")}
```

## Introduction
### 

This tutorial covers [Chapter 7: Mechanics](https://ppbds.github.io/primer/mechanics.html) of [*Preceptor’s Primer for Bayesian Data Science: Using the Cardinal Virtues for Inference*](https://ppbds.github.io/primer/) by [David Kane](https://davidkane.info/). 

In our haste to make progress — to get all the way through the process of building, interpreting and using models — we have given short shrift to some of the messy details of model building and evaluation. This chapter fills in those lacunae.

## Transforming variables 
### 

It is often convenient to transform a predictor variable so that our model makes more sense.

### 

Let's say we are interested in predicting a person's income based on their age. We have a model of `income` as a function of `age`: 
$$ income_i = \beta_0  + \beta_1 age_i + \epsilon_i$$
### Exercise 1

Load the **brms** package.

```{r transforming-variables-1, exercise = TRUE}

```

```{r transforming-variables-1-hint-1, eval = FALSE}
library(brms)
```

```{r transforming-variables-1-test, include = FALSE}
library(brms)
```

### 

### Exercise 2

Load the **tidyverse** package.

```{r transforming-variables-2, exercise = TRUE}

```

```{r transforming-variables-2-hint-1, eval = FALSE}
library(tidyverse)
```

```{r transforming-variables-2-test, include = FALSE}
library(tidyverse)
```

### 

### Exercise 3

We will be using the `trains` data set from **primer.data** for our model. Load the **primer.data** package.

```{r transforming-variables-3, exercise = TRUE}

```

```{r transforming-variables-3-hint-1, eval = FALSE}
library(primer.data)
```

```{r transforming-variables-3-test, include = FALSE}
library(primer.data)
```

### 

### Exercise 4

We will also be using a new package, **broom.mixed**, which allows us to tidy regression data for plotting. Load the **broom.mixed** package.

```{r transforming-variables-4, exercise = TRUE}

```

```{r transforming-variables-4-hint-1, eval = FALSE}
library(broom.mixed)
```

```{r transforming-variables-4-test, include = FALSE}
library(broom.mixed)
```

### 

### Exercise 5

Type `trains` and hit "Run Code".

```{r transforming-variables-5, exercise = TRUE}

```

```{r transforming-variables-5-hint-1, eval = FALSE}
trains
```

```{r transforming-variables-5-test, include = FALSE}
trains
```

### 

### Exercise 6

Create a model using `brm()` from the **brms**. Use the argument `formula = income ~ age`, `data = trains`, `family = gaussian()`, `refresh = 0`, `silent = 2`, and `seed = 45`.

Assign the result to an object called `fit_1`.


```{r transforming-variables-6, exercise = TRUE}

```

```{r transforming-variables-6-hint-1, eval = FALSE}
fit_1 <- brm(... = income ~ age, 
             data = ...,
             ... = gaussian(),
             ... = 2,
             refresh = ...,
             ... = 45)
```

```{r transforming-variables-6-test, include = FALSE}
fit_1 <- brm(formula = income ~ age, 
             data = trains,
             family = gaussian(),
             silent = 2,
             refresh = 0,
             seed = 45)
```

### 

### Exercise 7

Type `fit_1` and hit "Run Code."

```{r transforming-variables-7, exercise = TRUE}

```

```{r transforming-variables-7-hint-1, eval = FALSE}
fit_1
```

```{r transforming-variables-7-test, include = FALSE}
fit_1
```

### 

### Exercise 8

Run `fixef()` on `fit_1` and hit "Run Code."

```{r transforming-variables-8, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r transforming-variables-8-hint-1, eval = FALSE}
fixef(...)
```

```{r transforming-variables-8-test, include = FALSE}
fixef(fit_1)
```

### 

<!-- GK: Should we ask students to explain the meaning of the coefficient?  -->
The value of $\beta_0$, the intercept in the regression, is `r scales::comma(round(fixef(fit_1)["Intercept", "Estimate"], 0))`. This represent the estimated average income for a person with an age of zero, which is awkward and useless since there are no people of zero age in our data. 

### Exercise 9

One way to make the intercept more meaningful is to transform `age`. Start a pipe with `trains` to `mutate` with the argument `c_age = age - mean(age)`. Assign the result to a new object called `trains_2`.

```{r transforming-variables-9, exercise = TRUE}

```

```{r transforming-variables-9-hint-1, eval = FALSE}
... <- trains |> 
  mutate(... = age - ...(age))
```

```{r transforming-variables-9-test, include = FALSE}
trains_2 <- trains |> 
  mutate(c_age = age - mean(age))
```

### 

### Exercise 10

Copy your previous code from exercise 5, but set `formula` equal `income ~ c_age`, and `data` equal `trains_2`. Assign the result to an object called `fit_1_c`.

```{r transforming-variables-10, exercise = TRUE}

```

```{r transforming-variables-10-hint-1, eval = FALSE}
fit_1_c <- brm(formula = ..., 
               ... =  = trains_2,
               family = gaussian(),
               silent = 2,
               refresh = 0,
               seed = 16)
```

```{r transforming-variables-10-test, include = FALSE}
fit_1_c <- brm(formula = income ~ c_age, 
               data = trains_2,
               family = gaussian(),
               silent = 2,
               refresh = 0,
               seed = 16)
```

### 

### Exercise 11

Run `fixef()` on `fit_1_c` and hit "Run Code."

```{r transforming-variables-11, exercise = TRUE}

```

```{r transforming-variables-11-hint-1, eval = FALSE}
fixef(fit_1_c)
```

```{r transforming-variables-11-test, include = FALSE}
fixef(fit_1_c)
```

### 

The intercept, `r scales::comma(round(fixef(fit_1_c)["Intercept", "Estimate"], 0))`, is the expected income for someone with `c_age = 0`, i.e., someone of an average age in the data, which is around `r round(mean(trains$age), 0)`.
