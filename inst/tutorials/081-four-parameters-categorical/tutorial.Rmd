---
title: 'Four Parameters: Categorical'
author: David Kane and Tanay Janmanchi
tutorial:
  id: four-parameters-categorical
output:
  learnr::tutorial:
    progressive: yes
    'allow_skip:': yes
runtime: shiny_prerendered
description: 'Chapter 8 Tutorial: Four Parameters: Categorical'
---

```{r setup, include = FALSE}
library(learnr)
library(tutorial.helpers)
library(tidyverse)
library(brms)
library(tidybayes)
library(gtsummary)
library(primer.data)

knitr::opts_chunk$set(echo = FALSE)
options(tutorial.exercise.timelimit = 600, 
        tutorial.storage = "local") 

nes_92 <- nes |> 
  filter(year == 1992) |> 
  select(sex, pres_vote) |> 
  drop_na() |> 
  mutate(pres_vote = case_when(
    pres_vote == "Democrat" ~ "Clinton",
    pres_vote == "Republican" ~ "Bush",
    pres_vote == "Third Party" ~ "Perot",
  ))

# temperance <- fit_nes |> 
#   add_epred_draws(newdata = tibble(sex = c("Female", "Male"))) |>
#   select(sex, .category, .epred) |> 
#   ggplot(aes(x = .epred, fill = sex)) +
#     geom_histogram(bins = 100) +
#     facet_grid(~ .category) +
#     scale_x_continuous(breaks = c(0.05, 0.3, 0.6),
#       labels = scales::percent_format()) +
#     labs(title = "Posterior for Expected Probability of Candidate Support Among Women",
#           subtitle = "Women are most likely to support Clinton",
#           x = "Posterior Probability of Expected Vote Probability",
#           y = "Count",
#           fill = "Sex") 

# fit_nes <- brm(formula = pres_vote ~ sex,
#                data = nes_92,
#                family = categorical(),
#                silent = 2,
#                refresh = 0,
#                seed = 76)
# 
# write_rds(fit_nes, "data/fit_nes.rds")

fit_nes <- read_rds("data/fit_nes.rds")

ndata <- tibble(sex = c("Female", "Male"))

```

```{r copy-code-chunk, child = system.file("child_documents/copy_button.Rmd", package = "tutorial.helpers")}
```

```{r info-section, child = system.file("child_documents/info_section.Rmd", package = "tutorial.helpers")}
```

## Introduction
### 

This tutorial covers [Chapter 8: Four Parameters: Categorical](https://ppbds.github.io/primer/four-parameters-categorical.html) of [*Preceptor’s Primer for Bayesian Data Science: Using the Cardinal Virtues for Inference*](https://ppbds.github.io/primer/) by [David Kane](https://davidkane.info/).

## Wisdom
### 

*The only true wisdom is in knowing you know nothing.*  - Socrates

We start every problem with a question. Consider this:

> What is the relationship between sex and voting?

### 

In order to make progress we must make our question more specific. Here is our new question: 

> What was the relationship between sex and voting in the 1992 US Presidential election among supporters of the three leading candidates: Clinton, Bush and Perot?

### Exercise 1

In your own words, describe the key components of Wisdom for working on a data science problem.

```{r wisdom-1}
question_text(NULL,
	message = "Wisdom requires the creation of a Preceptor Table, an examination of our data, and a determination, using the concept of validity, as to whether or not we can (reasonably!) assume that the two come from the same population.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

If it is not *valid* to consider the data you have and the (theoretical) data from the Preceptor Table to have arisen out of the same population, your attempt to estimate your quantity of interest ends at the first stage. 

### Exercise 2

Define a Preceptor Table.

```{r wisdom-2}
question_text(NULL,
	message = "A Preceptor Table is the smallest possible table of data with rows and columns such that, if there is no missing data, it is easy to calculate the quantities of interest.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### Exercise 3

Describe the key components of Preceptor Tables in general, without worrying about this specific problem. Use words like "units," "outcomes," and "covariates."

```{r wisdom-3}
question_text(NULL,
	message = "The rows of the Preceptor Table are the units. The outcome is at least one of the columns. If the problem is causal, there will be at least two (potential) outcome columns. The other columns are covariates. If the problem is causal, at least one of the covariates will be a treatment.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

As we are considering *predicative model*, our Preceptor Table will have only one column for the potential outcome.


### Exercise 4

Create a Github repo called `four-parameters-categorical`. Be sure to add a README file. Connect the repo to a new R project titled `four-parameters-categorical`. Edit the `.gitignore` by adding `*Rproj`. 

In the Console, run:

```
tutorial.helpers::show_file(".gitignore")
```

CP/CR.

```{r wisdom-4}
question_text(NULL,
	answer(NULL, correct = TRUE),
	allow_retry = TRUE,
	try_again_button = "Edit Answer",
	incorrect = NULL,
	rows = 3)
```

### 

Commit and push the changes to GitHub, we will work more with this.

### Exercise 5

What are the units for this problem?

```{r wisdom-5}
question_text(NULL,
	message = "Individual US voters.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

We are looking at who voted for these three candidates: Bush, Clinton and Perot. The question suggests that we are not interested in people who did not vote, although one might explore if men were more or less likely to vote in the first place. As always, the initial question rarely specifies the Preceptor Table precisely.

### Exercise 6

What is/are the outcome/outcomes for this problem?

```{r wisdom-6}
question_text(NULL,
	message = "Presidential voting behavior in 1992",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

Such explorations are often restricted to just the two “major party” candidates, the nominees of the Democratic and the Republican parties, Bill Clinton and George HW Bush. But, in 1992, Ross Perot was a very successful “third party” candidate, winning almost 19% of the vote. Should he be included in the analysis? Again, the question does not specify. However, the outcome variable is certainly the candidate for whom an individual voted.

### Exercise 7

What are some covariates which you think might be useful for this problem?

```{r wisdom-7}
question_text(NULL,
	message = "We will certainly need sex, with two values: “male” and “female”. Other variables which might be helpful include party, income, race and past voting history.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

Covariates are any variable that might have some connection with the outcome. For example, Democrats are almost certainly going to vote for Clinton. For this model we will be measuring the `sex` variable.

### Exercise 8

What are the treatments, if any, for this problem?

```{r wisdom-8}
question_text(NULL,
	message = "There are no treatments.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

Since this represents a predicative model, there are no treatments.


### Exercise 9

What moment in time does the Preceptor Table refer to?

```{r wisdom-9}
question_text(NULL,
	message = "Fall of 1992",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### Exercise 10

Describe in words the Preceptor Table for this problem.

```{r wisdom-10}
question_text(NULL,
	message = "XX. Make sure your words given an excellent description of the Preceptor Table which you are about to show the student.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

The Preceptor Table for this problem looks something like this:

<!-- XX. Show the Preceptor Table. You can just copy/paste the code from the Primer. -->


### Exercise 11

Go to the console and type `?nes` to learn more about the data. Write one sentence describing the data you have to answer your question.

```{r wisdom-11}
question_text(NULL,
	message = "This dataset contains information starting from 1948, before and after each presidential election, and combines questions about voters' political attitudes with extensive biographical information.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### Exercise 12

What does the dependent variable represent in this data?

```{r wisdom-12}
question_text(NULL,
	message = "The candidate who an individual that was surveyed voted for.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### Exercise 13

Load the **primer.data** package.

```{r wisdom-13, exercise = TRUE}

```

```{r wisdom-13-hint-1, eval = FALSE}
library(...)
```

```{r wisdom-13-test, include = FALSE}
library(primer.data)
```

### Exercise 14

Load the **tidyverse** package.

```{r wisdom-14, exercise = TRUE}

```

```{r wisdom-14-hint-1, eval = FALSE}
library(...)
```

```{r wisdom-14-test, include = FALSE}
library(tidyverse)
```

### Exercise 15

Go to `File -> New File -> Quarto Document`. Title it "Four Parameters: Categorical". Make yourself the author. Save the file as `analysis.qmd`. Once you do this, delete everything below the YAML header and render the file. 

Add `execute:` 
        `echo: false` to the YAML header as well

In the Console, run : `tutorial.helpers::show_file("analysis.qmd")`. CP/CR


```{r wisdom-15}
question_text(NULL,
	answer(NULL, correct = TRUE),
	allow_retry = TRUE,
	try_again_button = "Edit Answer",
	incorrect = NULL,
	rows = 3)
```

### Exercise 16

Edit the `.gitignore` file to include `*_files`.
In the Console, run : `tutorial.helpers::show_file(".gitignore")`. CP/CR


```{r wisdom-16}
question_text(NULL,
	answer(NULL, correct = TRUE),
	allow_retry = TRUE,
	try_again_button = "Edit Answer",
	incorrect = NULL,
	rows = 3)
```

### Exercise 17

Create a new code chunk. Add `#| label: setup`, `#| echo: FALSE` and `#| message: FALSE` to the top of it. Load the **primer.data** and **tidyverse** packages into this code chunk. 

In the console, run: `tutorial.helpers::show_file("analysis.qmd", start = 6)`


```{r wisdom-17}
question_text(NULL,
	answer(NULL, correct = TRUE),
	allow_retry = TRUE,
	try_again_button = "Edit Answer",
	incorrect = NULL,
	rows = 3)
```

### 

### Exercise 18

Type `nes` below.

```{r wisdom-18, exercise = TRUE}

```

```{r wisdom-18-hint-1, eval = FALSE}
nes
```

```{r wisdom-18-test, include = FALSE}
nes
```

### Exercise 19

Pipe nes to `count()`, set the argument inside to `sex`

```{r wisdom-19, exercise = TRUE}
nes
```

```{r wisdom-19-hint-1, eval = FALSE}
nes |> count(...)
```

```{r wisdom-19-test, include = FALSE}

nes |> count(sex)

```

### 

We can see that there are over 4000 more female voters than male voters


### Exercise 20

Type nes below.

```{r wisdom-20, exercise = TRUE}

```

### Exercise 21

Pipe `nes` to `filter()` and set the argument `year` to `1992`.  


```{r wisdom-21, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r wisdom-21-hint-1, eval = FALSE}
nes |> 
  filter (...)
```

```{r wisdom-21-test, include = FALSE}
nes |> 
  filter(year == 1992)
```

### 

This only looks at data from the year 1992.

### Exercise 22

Continue the pipe with `select()`, be sure to select the `pres_vote` and `sex` columns

```{r wisdom-22, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r wisdom-22-hint-1, eval = FALSE}
... |>
  select(..., ...)
```

```{r wisdom-22-test, include = FALSE}
nes |> 
  filter(year == 1992) |>
  select(pres_vote, sex)
```

### 

This only keeps the data that we need, which is the candidate voted and the sex of the voter.


### Exercise 23

Continue the pipe with `drop_na()`

```{r wisdom-23, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r wisdom-23-hint-1, eval = FALSE}
... |> 
  drop_na()
```

```{r wisdom-23-test, include = FALSE}
nes |> 
  filter(year == 1992) |>
  select(pres_vote, sex) |>
  drop_na()
```

### 

This gets rid of NA values

### Exercise 24

Finish the pipe with `mutate()`. Set the `pres_vote` argument to `case_when()`. Inside of `case_when()`, change `pres_vote` from the name of the political party to the name of the candidate that was voted. (Look in the textbook to find the associated political parties).

<!-- Good news. We did this for you! Just hit run code. -->

<!-- TJ: Are these good directions? -->

```{r wisdom-24, exercise = TRUE}
# nes |> 
#   filter(year == 1992) |>
#   select(pres_vote, sex) |>
#   drop_na()
```

<button onclick = "transfer_code(this)">Copy previous code</button>


```{r wisdom-24-hint-1, eval = FALSE}
... |> 
  mutate(pres_vote = case_when(
    pres_vote == "Democrat" ~ ...,
    pres_vote == ... ~ "Bush",
    pres_vote == ... ~ ..,
  ))
```

```{r wisdom-24-test, include = FALSE}
nes |> 
  filter(year == 1992) |>
  select(pres_vote, sex) |>
  drop_na() |> 
  mutate(pres_vote = case_when(
    pres_vote == "Democrat" ~ "Clinton",
    pres_vote == "Republican" ~ "Bush",
    pres_vote == "Third Party" ~ "Perot",
  ))
```

### 

The data uses the name of the political party, but, we want the name of the candidate specifically.

### Exercise 25

Set this equal to a new object called `nes_92`. 

```{r wisdom-25, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r wisdom-25-hint-1, eval = FALSE}
nes_92 <- ...
```

```{r wisdom-25-test, include = FALSE}
nes_92 <- nes |> 
  filter(year == 1992) |>
  select(pres_vote, sex) |>
  drop_na() |> 
  mutate(pres_vote = case_when(
    pres_vote == "Democrat" ~ "Clinton",
    pres_vote == "Republican" ~ "Bush",
    pres_vote == "Third Party" ~ "Perot",
  ))
```

### 

Your code should look like this: 

```
nes_92 <- nes |> 
  filter(year == 1992) |> 
  select(sex, pres_vote) |> 
  drop_na() |> 
  mutate(pres_vote = case_when(
    pres_vote == "Democrat" ~ "Clinton",
    pres_vote == "Republican" ~ "Bush",
    pres_vote == "Third Party" ~ "Perot",
  ))
```

### 

This is the data we will use to create our model. 

### Exercise 26

Create a new code chunk. Add `#| label: cleaning`, `#| echo: FALSE` and `#| message: FALSE` to the top of it once again. Copy and paste the code to above into the code chunk. Render the document.

In the console, run: `tutorial.helpers::show_file("analysis.qmd, start = -12")`. CP/CR

```{r wisdom-26}
question_text(NULL,
	answer(NULL, correct = TRUE),
	allow_retry = TRUE,
	try_again_button = "Edit Answer",
	incorrect = NULL,
	rows = 3)
```

### Exercise 27

In your own words, define "validity" as we use the term.

```{r wisdom-27}
question_text(NULL,
	message = "Validity is the consistency, or lack thereof, in the columns of the data set and the corresponding columns in the Preceptor Table.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

In order to consider the two data sets to be drawn from the same population, the columns from one must have a valid correspondence with the columns in the other. Validity, if true (or at least reasonable), allows us to construct the Population Table, which is the first step in Justice.

### Exercise 28

What can't we do if the assumption of validity is not true?

```{r wisdom-28}
question_text(NULL,
	message = "We can't combine the Preceptor Table and the data in order to construct the Population Table.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### Exercise 29

Provide one reason why the assumption of validity might not hold for this problem.

```{r wisdom-29}
question_text(NULL,
	message = "People may claim that they voted for one candidate when they really voted for another. This causes the data in the population table to not match up with the columns in the Preceptor Table",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

More people claim to have voted for the winning candidate than the actual number of votes that they receive.

### Exercise 30

Summarize the state of your work so far in one sentence. Make reference to the data you have and to the specific question you are trying to answer. 

```{r wisdom-30}
question_text(NULL,
	message = "Using data from the National Election Studies survey of US citizens, we seek to understand the relationship between voter preference and sex in the 1992 Presidential election.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

Edit you answer as you see fit, but do not copy/paste our answer exactly. Add this summary to `analysis.qmd`, `Command/Ctrl + Shift + K`, and then commit/push.

## Justice
### 

*Justice delayed is justice denied.* - William E. Gladstone


### Exercise 1

In your own words, name the four key components of Justice for working on a data science problem.

```{r justice-1}
question_text(NULL,
	message = "Justice concerns four topics: the Population Table, stability, representativeness, and unconfoundedness.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### Exercise 2

In your own words, define a Population Table.

```{r justice-2}
question_text(NULL,
	message = "The Population Table includes a row for each unit/time combination in the underlying population from which both the Preceptor Table and the data are drawn.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

It can be constructed if the validity assumption is (mostly) true. It includes all the rows from the Preceptor Table. It also includes the rows from the data set. It usually has other rows as well, rows which represent unit/time combinations from other parts of the population.

### Exercise 3

In your own words, define the assumption of "stability" when employed in the context of data science.

```{r justice-3}
question_text(NULL,
	message = "Stability means that the relationship between the columns in the Population Table is the same for three categories of rows: the data, the Preceptor Table, and the larger population from which both are drawn.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

Stability is all about *time*. Is the relationship among the columns in the Population Table stable over time? In particular, is the relationship --- which is another way of saying "mathematical formula" --- at the time the data was gathered the same as the relationship at the (generally later) time references by the Preceptor Table.


### Exercise 4

Provide one reason why the assumption of stability might not be true in this case.

```{r justice-4}
question_text(NULL,
	message = "Some voters cast their ballots weeks before election day.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

Which would mean that the Preceptor Table and the data do not come from the same moment in time.


### Exercise 5

In your own words, define the assumption of "representativeness" when employed in the context of data science.

```{r justice-5}
question_text(NULL,
	message = "Representativeness, or the lack thereof, concerns two relationship, among the rows in the Population Table. The first is between the Preceptor Table and the other rows. The second is between our data and the other rows.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

Ideally, we would like both the Preceptor Table *and* our data to be random samples from the population. Sadly, this is almost never the case.



### Exercise 6

Provide one reason why the assumption of representativeness might not be true in this case.

```{r justice-6}
question_text(NULL,
	message = "The assumption of representativeness might not be true because the sample of our data is not random enough.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

The sample that we are using may not accurately represent the rest of the population.



### Exercise 7

In your own words, define the assumption of "unconfoundedness" when employed in the context of data science.

```{r justice-7}
question_text(NULL,
	message = "Unconfoundedness means that the treatment assignment is independent of the potential outcomes, when we condition on pre-treatment covariates.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

Because this is a predictive, not causal, model, the assumption of unconfoundedness is irrelevant.


### Exercise 8

Summarize the state of your work so far in two or three sentences. Make reference to the data you have and to the question you are trying to answer. Feel free to copy from your answer at the end of the Wisdom Section. Mention at least one specific problem which casts doubt on your approach. 




```{r justice-8}
question_text(NULL,
	message = "Using data from the National Election Studies (NES) survey of US citizens, we seek to understand the relationship between voter preference and sex in the 1992 Presidential election. Our results might be biased by differential non-response among different categories of voters.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

## Courage
### 

*Courage is the commitment to begin without any guarantee of success.* - Johann Wolfgang von Goethe


### Exercise 1

In your own words, name the key goal of Courage and the process we use to get there.

```{r courage-1}
question_text(NULL,
	message = "Courage selects the data generating mechanism. We first specify the mathematical formula which connects the outcome variable we are interested in with the other data that we have. We explore different models. We need to decide which variables to include and to estimate the values of unknown parameters. We check our models for consistency with the data we have. We avoid hypothesis tests. We select one model.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### Exercise 2

Load the **brms** package

```{r courage-2, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r courage-2-hint-1, eval = FALSE}
library(...)
```

```{r courage-2-test, include = FALSE}
library(brms)
```

### Exercise 3

Load the **tidybayes** package

```{r courage-3, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r courage-3-hint-1, eval = FALSE}
library(...)
```

```{r courage-3-test, include = FALSE}
library(tidybayes)
```

### 

### Exercise 4

Add `library(brms)` and `library(tidybayes)` to the `setup` code chunk in `analysis.qmd`. `Command/Ctrl + Shift + K`. At the Console, run:

```
tutorial.helpers::show_file("analysis.qmd", pattern = "brms|tidybayes")
```

CP/CR.

```{r courage-4}
question_text(NULL,
	answer(NULL, correct = TRUE),
	allow_retry = TRUE,
	try_again_button = "Edit Answer",
	incorrect = NULL,
	rows = 3)
```

### 

### Exercise 5

Make a model using `brm()` from the **brms** package. Your arguments should be: `formula = pres_vote ~ sex`, `data = nes_92`, `family = categorical()`, `silent = 2`, `refresh = 0` and `seed = 76`


Assign the result to an object called `fit_nes`. It may take a while to run, so be patient.

```{r courage-5, exercise = TRUE}

```

```{r courage-5-hint-1, eval = FALSE}
fit_nes <- brm(... = pres_vote ~ sex,
               ... = nes_92,
               ... = categorical(),
               silent = ...,
               refresh = ...,
               seed = ...)
```

### 

Your code should look like this:

```
fit_nes <- brm(formula = pres_vote ~ sex,
               data = nes_92,
               family = categorical(),
               silent = 2,
               refresh = 0,
               seed = 76)
```

### Exercise 6

Behind the scenes, we have assigned the result of the `brm()` call to an object named `fit_nes`. Type `fit_nes` and hit "Run Code." This generates the same results as using `print(fit_nes)`.


```{r courage-6, exercise = TRUE}

```

```{r courage-6-hint-1, eval = FALSE}
fit_nes
```

```{r courage-6-test, include = FALSE}
# fit_nes
```

### Exercise 7

Run `family()` on `fit_nes`. `family()` provides information about the "family" of the error term and the link between it and the dependent variable.


```{r courage-7, exercise = TRUE}

```

```{r courage-7-hint-1, eval = FALSE}
family(...)
```

```{r courage-7-test, include = FALSE}
# family(fit_nes)
```

### 

A categorical model is like a logistic model, but, it has more than two options instead of the standard binary dependant variable.


### Exercise 8

Run `formula()` on `fit_nes`. `formula()` returns the statistical equation which relates the dependent variable to the independent variable(s).


```{r courage-8, exercise = TRUE}

```

```{r courage-8-hint-1, eval = FALSE}
formula(...)
```

```{r courage-8-test, include = FALSE}
# formula(fit_nes)
```

### Exercise 9

Run `nobs()` on `fit_nes`. The `nobs()` function returns the **n**umber of **obs**ervations.

```{r courage-9, exercise = TRUE}

```

```{r courage-9-hint-1, eval = FALSE}
nobs(...)
```

```{r courage-9-test, include = FALSE}
nobs(fit_nes)
```

### 

In this case, `fit_nes` has 1658 recorded observations

### Exercise 10

<!-- TJ: I need help with this section -->

Write the mathematical formula for your model, using $\LaTeX$ math notation.

```{r courage-10}
question_text(NULL,
	message = "XX",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

Add the formula to `analysis.qmd`. `Command/Ctrl + Shift + K`. Ensure that the formula is looks correct. 



### Exercise 11

Create a new code chunk in `analysis.qmd`. Add two code chunk options: `label: model` and `cache: true`. Copy/paste the code from above for estimating the model using `brm()` into the code chunk, assining the result to `fit_nes`. 

`Command/Ctrl + Shift + K`. It may take some time to render `analysis.qmd`, depending on how complex your model is. But, by including `cache: true` you cause Quarto to cache the results of the chunk. The next time you render `analysis.qmd`, as long as you have not changed the code, Quarto will just load up the saved fitted object.

To confirm, `Command/Ctrl + Shift + K` again. It should be quick.

At the Console, run:

```
tutorial.helpers::show_file("analysis.qmd", start = -8)
```

CP/CR.

```{r courage-11}
question_text(NULL,
	answer(NULL, correct = TRUE),
	allow_retry = TRUE,
	try_again_button = "Edit Answer",
	incorrect = NULL,
	rows = 3)
```

### Exercise 12

Run `posterior_interval()` on `fit_nes`. The `posterior_interval()` function returns 95% intervals for all the parameters in our model.

```{r courage-12, exercise = TRUE}

```

```{r courage-12-hint-1, eval = FALSE}
posterior_interval(...)
```

```{r courage-12-test, include = FALSE}
posterior_interval(fit_nes)
```

### 

The positive value for `muPerot_sexMale` means that men are much more likely to vote for Perot.


### Exercise 13

Run `fixef()` on `fit_nes`. The `fixef()` returns information about the **fix**ed **ef**fects in the model.

```{r courage-13, exercise = TRUE}

```

```{r courage-13-hint-1, eval = FALSE}
fixef(...)
```

```{r courage-13-test, include = FALSE}
fixef(fit_nes)
```

### 

The negative value for `muClinton_sexMale` means that men are less likely to vote for Perot.

### Exercise 14

Run `pp_check()` on `fit_nes`. The `pp_check()` runs a **p**osterior **p**redictive check.

```{r courage-14, exercise = TRUE}

```

```{r courage-14-hint-1, eval = FALSE}
pp_check(...)
```

```{r courage-14-test, include = FALSE}
pp_check(fit_nes)
```

### 

`pp_check()` is used to examine if the “fake data” created from our DGM matches our actual data. If the fake data had looked very different from the real data, we have had a problem. But, for the most part, we conclude that, although not perfect, `pp_check()` shows that the fake outcomes generated by our model are like the actual outcome data.

### Exercise 15

Use `library()` to load the [**gtsummary**](https://www.danieldsjoberg.com/gtsummary) package.

```{r courage-15, exercise = TRUE}

```

```{r courage-15-hint-1, eval = FALSE}
library(gtsummary)
```

```{r courage-15-test, include = FALSE}
library(gtsummary)
```

### Exercise 16

It is also possible to summarize the regression results using the function provided by the **gtsummary** package. 

Pipe `fit_nes` to `tbl_regression()`

<!-- DK: Clean up. -->

```{r courage-16, exercise = TRUE}

```

```{r courage-16-hint-1, eval = FALSE}
tbl_regression(...)
```

```{r courage-16-test, include = FALSE}
# tbl_regression(fit_nes)
```

### 

This is the regression table that we will put into our document.

### Exercise 17

Make a new code chunk at the bottom of the document, add `#| label: table`. Copy and paste the line `tbl_regression(fit_nes)` into the code chunk. Save the file and in the Console, run:

`tutorial.helpers::show_file("analysis.qmd", start = -2)`

```{r courage-17}
question_text(NULL,
	answer(NULL, correct = TRUE),
	allow_retry = TRUE,
	try_again_button = "Edit Answer",
	incorrect = NULL,
	rows = 3)
```

### Exercise 18

Write a few sentences which summarize your work so far. The first few sentences are the same as what you had at the end of the Justice Section. Add at least one sentence which describes the modelling approach which you are using, specifying at least the functional form and the dependent variable. Add at least one sentence which describes the *direction* (not the magnitude) of the relationship between one of your independent variables and your dependent variable.

```{r courage-18}
question_text(NULL,
	message = "Using data from the National Election Studies (NES) survey of US citizens, we seek to understand the relationship between voter preference and sex in the 1992 Presidential election. Our results might be biased by differential non-response among different categories of voters. We modeled pres_vote, a character variable, as a multinomial logistic regression model. Women are most likely to support Clinton. ",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

## Temperance
### 

*Temperance is a tree which as for its root very little contentment, and for its fruit calm and peace.* - Buddha



### Exercise 1

In your own words, describe the use of Temperance in data science.

```{r temperance-1}
question_text(NULL,
	message = "Temperance uses the Data Generating Mechanism to answer the question with which we began. Humility reminds us that this answer is always a lie.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### Exercise 2

What is the general topic we are investigating? What is the specific question we are trying to answer? 

```{r temperance-2}
question_text(NULL,
	message = "Our general topic is: What is the relationship between sex and voting? Specifically, we want to know: What was the relationship between sex and voting in the 1992 US Presidential election among supporters of the three leading candidates: Clinton, Bush and Perot?",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

Data science projects almost always begin with a broad topic of interest. Yet, in order to make progress, we need to drill down to a specific question. This leads to the creation of a data generating mechanism, which can now be used to answer lots of questions, thus allowing us to explore the original topic broadly.


<!-- DK: Make plot in tutorial first, then copy/paste. Done-->

### Exercise 3

To answer our question, we need to create a `newdata` object. Which variables do we need to include in this object?

```{r temperance-3}
question_text(NULL,
	message = "We just want the sex variable",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

### Exercise 4

How many rows do we need in the `newdata` object? Recall that each row will generate a posterior for something. That is, if you have two rows in your `newdata` object, you will get two posteriors. It is up to you to determine what those two posteriors are and what you want to do with them.

```{r temperance-4}
question_text(NULL,
	message = "2 rows",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

### Exercise 5

Which values do you want the variables in your `newdata` object to have? This is not easy! 

```{r temperance-5}
question_text(NULL,
	message = "We want the sex values of Male and Female",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

### Exercise 6

Here is the R code which creates the `newdata` object: `tibble(sex = c("Female", "Male"))`. Type it into the code exercise block and hit "Run Code."

<!-- Asking students to create this object --- even after you help them figure out the columns, rows and values --- is too hard, at least until they get more experiences. Your knowledge drop, for this question and the next, should give them advice on the broad topic of how they can create newdata objects themselves. -->

```{r temperance-6, exercise = TRUE}

```

```{r temperance-6-hint-1, eval = FALSE}
tibble(sex = c(..., ...))
```

```{r temperance-6-test, include = FALSE}
tibble(sex = c("Female", "Male"))
```

### 

### Exercise 7

Behind the scenes, we have created the `ndata` object using this code. To confirm, type `ndata` and hit "Run Code."

```{r temperance-7, exercise = TRUE}

```

```{r temperance-7-hint-1, eval = FALSE}
ndata
```

```{r temperance-7-test, include = FALSE}
ndata
```

### 

### Exercise 8

Now that we have the `newdata` object, we can create a pipe which uses out fitted model to answer our question. Begin by typing `fit_nes` and clicking "Run Code."

```{r temperance-8, exercise = TRUE}

```

```{r temperance-8-hint-1, eval = FALSE}
fit_nes
```

```{r temperance-8-test, include = FALSE}
fit_nes
```

### 

<!-- XX: Again, the main point of knowledge drops is this area is to explain to students why the newdata object looks the way it does and what it will produce. A great way to teach is via example. That is, explaining that if we had another way with these values, then we would get this posterior. Or, explaining what would be produced if we used add_epred instead of add_predict, and vice verse. -->

### Exercise 9

Pipe `fit_nes` to `add_epred_draws()` with the argument `newdata = ndata`.



```{r temperance-9, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r temperance-9-hint-1, eval = FALSE}
fit_nes |> add_epred_draws(...)
```

```{r temperance-9-test, include = FALSE}
fit_nes |> 
  add_epred_draws(newdata = ndata)
```

### 

Now we can see here tha there are a total of 24,000 rows. Each posterior has 4,000 rows, so why are there 24,000? Since we have two different values for `sex` (Male and Female) and three different values for `.category` (Bush, Clinton and Perot). So, if we multiply 4,000 by 6, we get a total of 24,000 rows.

<!-- TJ: Will expand on this explanation -->

<!-- XX: How do students know whether to use add_epred_draws or add_predicted_draws? This is non-trivial. On some level, we just tell them with the above command. (We don't make them guess.) But we also address this issue explicitly in various knowledg drops, especially this one. -->

<!-- XX: Insert as many questions as necessary to build a nice-looking example of your final plot. In early chapters, this is simple since our questions are simple. They are just one posterior. In later chapters, they become more complex, with the inclusion of several posteriors, as well as manipulation of them to calculate causal effects and whatnot. See the voting postcard example. -->



### Exercise 10

Continue the pipe with `select`, select `sex`, `.category` and `.epred`.

```{r temperance-10, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r temperance-10-hint-1, eval = FALSE}
... |> select(...)
```

```{r temperance-10-test, include = FALSE}
fit_nes |> 
  add_epred_draws(newdata = ndata) |>
  select(sex, .category, .epred)
```

### Exercise 11

Add `ggplot` to the pipe. Set the argument inside to be `aes(x = .epred, fill = sex)`

```{r temperance-11, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r temperance-11-hint-1, eval = FALSE}
... |> 
  ggplot(aes(...))
```

```{r temperance-11-test, include = FALSE}
fit_nes |> 
  add_epred_draws(newdata = ndata) |>
  select(sex, .category, .epred) |>
  ggplot(aes(x = .epred, fill = sex))
```

### Exercise 12

Add `geom_histogram`, set `bins` equal to `100.`

```{r temperance-12, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r temperance-12-hint-1, eval = FALSE}
... + 
  geom_histogram(...)
```

```{r temperance-12-test, include = FALSE}
fit_nes |> 
  add_epred_draws(newdata = ndata) |>
  select(sex, .category, .epred) |>
  ggplot(aes(x = .epred, fill = sex)) +
    geom_histogram(bins = 100)
```

### Exercise 13

Next add `facet_grid(~ .category)`

```{r temperance-13, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r temperance-13-hint-1, eval = FALSE}
... + 
  facet_grid(~ .category)
```

```{r temperance-13-test, include = FALSE}
fit_nes |> 
  add_epred_draws(newdata = ndata) |>
  select(sex, .category, .epred) |>
  ggplot(aes(x = .epred, fill = sex)) +
    geom_histogram(bins = 100) +
    facet_grid(~ .category)
```

### Exercise 14

Add `scale_x_continuous()` to the function. Set `breaks` to `c(0.05, 0.3, 0.6)` and `labels` to `scales::percent_format()`

```{r temperance-14, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r temperance-14-hint-1, eval = FALSE}
... +
  scale_x_continuous(breaks = c(...,
                                ...,
                                ...),
                     labels = ...)
```

```{r temperance-14-test, include = FALSE}
fit_nes |> 
  add_epred_draws(newdata = ndata) |>
  select(sex, .category, .epred) |>
  ggplot(aes(x = .epred, fill = sex)) +
    geom_histogram(bins = 100) +
    facet_grid(~ .category) +
    scale_x_continuous(breaks = c(0.05,
                                   0.3,
                                   0.6),
                       labels = scales::percent_format())
```

 
### Exercise 15

Finally, use `labs()` to add your labels. Your plot should look like this:


```{r}
fit_nes |> 
  add_epred_draws(newdata = tibble(sex = c("Female", "Male"))) |>
  select(sex, .category, .epred) |>
  ggplot(aes(x = .epred, fill = sex)) +
    geom_histogram(bins = 100) +
    facet_grid(~ .category) +
    scale_x_continuous(breaks = c(0.05, 0.3, 0.6),
      labels = scales::percent_format()) +
    labs(title = "Posterior for Expected Probability of Candidate Support Among Women",
          subtitle = "Women are most likely to support Clinton",
          x = "Posterior Probability of Expected Vote Probability",
          y = "Count",
          fill = "Sex")
```

```{r temperance-15, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>


```{r temperance-15-test, include = FALSE}
fit_nes |> 
  add_epred_draws(newdata = tibble(sex = c("Female", "Male"))) |>
  select(sex, .category, .epred) |> 
  ggplot(aes(x = .epred, fill = sex)) +
    geom_histogram(bins = 100) +
    facet_grid(~ .category) +
    scale_x_continuous(breaks = c(0.05, 0.3, 0.6),
      labels = scales::percent_format()) +
    labs(title = "Posterior for Expected Probability of Candidate Support Among Women",
          subtitle = "Women are most likely to support Clinton",
          x = "Posterior Probability of Expected Vote Probability",
          y = "Count",
          fill = "Sex") 
```

### 

### Exercise 16

Create a new code chunk in `analysis.qmd`. Label it with `label: plot`. Copy/paste the code which creates your graphic. `Command/Ctrl + Shift + K` to ensure that it all works as intended.

At the Console, run:

```
tutorial.helpers::show_file("XX.qmd", start = -13)
```

CP/CR.

```{r temperance-16}
question_text(NULL,
	answer(NULL, correct = TRUE),
	allow_retry = TRUE,
	try_again_button = "Edit Answer",
	incorrect = NULL,
	rows = 3)
```

### 

### Exercise 17

Write a paragraph which summarizes the project in your own words. The first few sentences are the same as what you had at the end of the Courage Section. But, since your question may have evolved, you should feel free to change those sentences. Add at least one sentence which describes at least one quantity of interest (QoI) --- presumably one that answers your question -- and which provides a measure of uncertainty about that QoI.


```{r temperance-17}
question_text(NULL,
	message = "Using data from the National Election Studies (NES) survey of US citizens, we seek to understand the relationship between voter preference and sex in the 1992 Presidential election. Our results might be biased by differential non-response among different categories of voters. We modeled pres_vote, a character variable, as a multinomial logistic regression model. Women are most likely to support Clinton.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

<!-- TJ: Need help with the QoI question -->


### Exercise 18

Write a few sentences which explain why the estimates for the quantities of interest, and the uncertainty thereof, might be wrong. Suggest an alternative estimate and confidence interval.

```{r temperance-18}
question_text(NULL,
	message = "XX",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

<!-- TJ: Need help with this question as well -->

### Exercise 19

<!-- DK: Publish after the switch of the material. -->

Publish `analysis.qmd` to Rpubs. Choose a sensible slug. Copy/paste the url below.

```{r temperance-19}
question_text(NULL,
	answer(NULL, correct = TRUE),
	allow_retry = TRUE,
	try_again_button = "Edit Answer",
	incorrect = NULL,
	rows = 3)
```

### 

### Exercise 20

Rearrange the material in `analysis.qmd` so that the order is graphic, paragraph, math and table. Doing so, of course, requires sensible judgment. For example, the code chunk which creates the fitted model must occur before the chunk which creates the graphic. `Command/Ctrl + Shift + K` to ensure that everything works.

At the Console, run:

```
tutorial.helpers::show_file("analysis.qmd")
```

CP/CR.

```{r temperance-20}
question_text(NULL,
	answer(NULL, correct = TRUE),
	allow_retry = TRUE,
	try_again_button = "Edit Answer",
	incorrect = NULL,
	rows = 3)
```

### 

Add `rsconnect` to the `.gitignore` file. You don't want your personal Rpubs details stored in the clear on Github. Commit/push everything.

## Summary
### 

This tutorial covered [Chapter 8: Four Parameters: Categorical](https://ppbds.github.io/primer/four-parameters-categorical.html) of [*Preceptor’s Primer for Bayesian Data Science: Using the Cardinal Virtues for Inference*](https://ppbds.github.io/primer/) by [David Kane](https://davidkane.info/). 




```{r download-answers, child = system.file("child_documents/download_answers.Rmd", package = "tutorial.helpers")}
```
