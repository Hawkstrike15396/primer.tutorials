---
title: 'Four Parameters: Categorical'
author: David Kane and Tanay Janmanchi
tutorial:
  id: four-parameters-categorical
output:
  learnr::tutorial:
    progressive: yes
    'allow_skip:': yes
runtime: shiny_prerendered
description: 'Chapter 8 Tutorial: Four Parameters: Categorical'
---

```{r setup, include = FALSE}
library(learnr)
library(tutorial.helpers)
library(tidyverse)
library(brms)
library(tidybayes)
library(gtsummary)
library(primer.data)

knitr::opts_chunk$set(echo = FALSE)
options(tutorial.exercise.timelimit = 600, 
        tutorial.storage = "local") 

nes_92 <- nes |> 
  filter(year == 1992) |> 
  select(sex, pres_vote) |> 
  drop_na() |> 
  mutate(pres_vote = case_when(
    pres_vote == "Democrat" ~ "Clinton",
    pres_vote == "Republican" ~ "Bush",
    pres_vote == "Third Party" ~ "Perot",
  ))

# fit_nes <- brm(formula = pres_vote ~ sex,
#                data = nes_92,
#                family = categorical(),
#                silent = 2,
#                refresh = 0,
#                seed = 76)
# 
# write_rds(fit_nes, "data/fit_nes.rds")

fit_nes <- read_rds("data/fit_nes.rds")

```

```{r copy-code-chunk, child = system.file("child_documents/copy_button.Rmd", package = "tutorial.helpers")}
```

```{r info-section, child = system.file("child_documents/info_section.Rmd", package = "tutorial.helpers")}
```

<!-- This is the template tutorial for creating any tutorial which uses the Cardinal Virtues to answer a question given a data set. Although its primary use is for the main chapters in the Primer, it could be used for other assignments as well. The letters `XX` are used to indicate locations which require editing. Comments with instructions are interspersed. Read https://ppbds.github.io/primer/key-concepts.html for details on the Cardinal Virtues. -->

<!-- There should be a bunch of quotes for each Cardinal Virtue. All quotes are listed at the introduction of each section. Select just one for each virtue in this tutorial. -->

<!-- There are many opportunities for knowledge drops, especially after definition questions. Use them! Point out something about the details of the particular problem from the chapter. Recall that students often won't read the chapter, so we need to pull out the highlights. -->

<!-- The more that questions force students to consult the chapter, the better. -->

<!-- Key problems with current version: We need (?) to flesh out the Courage and Temperance sections. Key skills to practice each time including writing math formulas in Quarto and creating nice looking tables of regression results. -->

<!-- Make sure to uncomment the tests once they are ready to work. -->


## Introduction
### 

This tutorial covers [Chapter 8: Four Parameters: Categorical](https://ppbds.github.io/primer/four-parameters-categorical.html) of [*Preceptor’s Primer for Bayesian Data Science: Using the Cardinal Virtues for Inference*](https://ppbds.github.io/primer/) by [David Kane](https://davidkane.info/).

## Wisdom
*The only true wisdom is in knowing you know nothing.*  - Socrates

### Exercise 1

In your own words, describe the key components of Wisdom for working on a data science problem.

```{r wisdom-1}
question_text(NULL,
	message = "Wisdom requires the creation of a Preceptor Table, an examination of our data, and a determination, using the concept of validity, as to whether or not we can (reasonably!) assume that the two come from the same population.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

### Exercise 2

Define a Preceptor Table.

```{r wisdom-2}
question_text(NULL,
	message = "A Preceptor Table is the smallest possible table of data with rows and columns such that, if there is no missing data, it is easy to calculate the quantities of interest.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

Always start your data science work by determining what data you would like to have in order to answer the question easily.

### Exercise 3

Describe the key components of Preceptor Tables in general, without worrying about this specific problem.

```{r wisdom-3}
question_text(NULL,
	message = "The rows of the Preceptor Table are the units. The outcome is at least one of the columns. If the problem is causal, there will be at least two (potential) outcome columns. The other columns are covariates. If the problem is causal, at least one of the covariates will be a treatment.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

### Exercise 4

What are the units for this problem?

```{r wisdom-4}
question_text(NULL,
	message = "Who voted for these three candidates: Bush, Clinton and Perot",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### Exercise 5

What is/are the outcome/outcomes for this problem?

```{r wisdom-5}
question_text(NULL,
	message = "Which of these three candidates did you vote for?",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

### Exercise 6

What are the covariates for this problem?

```{r wisdom-6}
question_text(NULL,
	message = " The only covariate we will consider is sex, with two values: “male” and “female”.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

We use covariates to model the outcome.

### Exercise 7

What are the treatments, if any, for this problem?

```{r wisdom-7}
question_text(NULL,
	message = "There are no treatments.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

Since this represents a predicative model, there are no treatments being observed.
### 

### Exercise 8

What moment in time does the Preceptor Table refer to?

```{r wisdom-8}
question_text(NULL,
	message = "Fall of 1992",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

<!-- DK: It is a feature that this question almost forces students to go to the chapter and read about the data. -->

### Exercise 9

Go to the console and type `?nes` to learn more about the data. Write two sentences describing the data you have to answer your question.


```{r wisdom-9}
question_text(NULL,
	message = "This dataset is from the American National Election Studies (ANES), a survey that aims to provide insights into voter behavior. It has been conducted since 1948 before and after each presidential election, and combines questions about voters' political attitudes with extensive biographical information.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

###

As you will find out later, we will not use all of this data.

### Exercise 10

Load the **tidyverse** package.

```{r wisdom-10, exercise = TRUE}

```

```{r wisdom-10-hint-1, eval = FALSE}
library(...)
```

```{r wisdom-10-test, include = FALSE}
library(tidyverse)
```

### 


### Exercise 11

What does the dependent variable represent in this data?

```{r wisdom-11}
question_text(NULL,
	message = "The candidate who an individual that was surveyed voted for.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### Exercise 12

Load the `primer.data*` package.

```{r wisdom-12, exercise = TRUE}

```

```{r wisdom-12-hint-1, eval = FALSE}
library(...)
```

```{r wisdom-12-test, include = FALSE}
library(primer.data)
```



### Exercise 13

Type `nes` below.

```{r wisdom-13, exercise = TRUE}

```

```{r wisdom-13-hint-1, eval = FALSE}

```

```{r wisdom-13-hint-2, eval = FALSE}
nes
```

```{r wisdom-13-test, include = FALSE}
nes
```

### Exercise 14


Pipe `count()` to nes, set the `.by` argument equal to `sex`

```{r wisdom-14, exercise = TRUE}

```

```{r wisdom-14-hint-1, eval = FALSE}
nes |> count(...)
```

```{r wisdom-14-test, include = FALSE}

nes |> count(.by = sex)

```

### 

We can see that there are over 4000 more female voters than male voters




### Exercise 15

In your own words, define "validity" as we use the term.

```{r wisdom-15}
question_text(NULL,
	message = "Validity is the consistency, or lack thereof, in the columns of the data set and the corresponding columns in the Preceptor Table.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

We have two tables: the data from American National Election Studies and the Preceptor Table.

### Exercise 16

What can't we do if the assumption of validity is not true?

```{r wisdom-16}
question_text(NULL,
	message = "We can't combine the Preceptor Table and the data in order to construct the Population Table.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

###

### Exercise 17

Provide one reason why the assumption of validity might not hold for this problem.

```{r wisdom-17}
question_text(NULL,
	message = "People may claim that they voted for one candidate when they really voted for another. This causes the data in the population table to not match up with the columns in the Preceptor Table",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

More people claim to have voted for the winning candidate than the actual number of votes that they receive.

### Exercise 18


Summarize the state of your work so far in one or two sentences. Make reference to the data you have and to the question you are trying to answer. 

```{r wisdom-18}
question_text(NULL,
	message = "Using data from the National Election Studies survey of US citizens, we seek to understand the relationship between voter preference and sex in the 1992 Presidential election.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

## Justice
### 

*Justice delayed is justice denied.* - William E. Gladstone


### Exercise 1

In your own words, name the four key components of Justice for working on a data science problem.

```{r justice-1}
question_text(NULL,
	message = "Justice concerns four topics: the Population Table, stability, representativeness, and unconfoundedness.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

### Exercise 2

In your own words, define a Population Table.

```{r justice-2}
question_text(NULL,
	message = "The Population Table includes a row for each unit/time combination in the underlying population from which both the Preceptor Table and the data are drawn.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### Exercise 3

In your own words, define the assumption of "stability" when employed in the context of data science.

```{r justice-3}
question_text(NULL,
	message = "Stability means that the relationship between the columns in the Population Table is the same for three categories of rows: the data, the Preceptor Table, and the larger population from which both are drawn.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

Stability is all about *time*. Is the relationship among the columns in the Population Table stable over time? In particular, is the relationship --- which is another way of saying "mathematical formula" --- at the time the data was gathered the same as the relationship at the (generally later) time references by the Preceptor Table.


### Exercise 4

Provide one reason why the assumption of stability might not be true in this case.

```{r justice-4}
question_text(NULL,
	message = "Some voters cast their ballots weeks before election day.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

Which would mean that the Preceptor Table and the data do not come from the same moment in time.
### 

### Exercise 5

In your own words, define the assumption of "representativeness" when employed in the context of data science.

```{r justice-5}
question_text(NULL,
	message = "Representativeness, or the lack thereof, concerns two relationship, among the rows in the Population Table. The first is between the Preceptor Table and the other rows. The second is between our data and the other rows.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```


###

The more expansive your Preceptor Table, the more important the assumption of representativeness becomes. 



### Exercise 6

Provide one reason why the assumption of representativeness might not be true in this case.

```{r justice-6}
question_text(NULL,
	message = "Representativeness might fail if the data from the Population Table does not match the columns in the Preceptor Table",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

The sample that we are using may not accurately represent the rest of the population.

### 

### Exercise 7

In your own words, define the assumption of "unconfoundedness" when employed in the context of data science.

```{r justice-7}
question_text(NULL,
	message = "Unconfoundedness means that the treatment assignment is independent of the potential outcomes, when we condition on pre-treatment covariates.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

Because this is a predictive, not causal, model, the assumption of unconfoundedness is irrelevant.

### 

### Exercise 8

Summarize the state of your work so far in two or three sentences. Make reference to the data you have and to the question you are trying to answer. Feel free to copy from your answer at the end of the Wisdom Section. Mention at least one specific problem which casts doubt on your approach. 




```{r justice-8}
question_text(NULL,
	message = "Using data from the National Election Studies (NES) survey of US citizens, we seek to understand the relationship between voter preference and sex in the 1992 Presidential election. Our results might be biased by differential non-response among different categories of voters.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```


## Courage

### 

*Courage is the commitment to begin without any guarantee of success.* - Johann Wolfgang von Goethe


### Exercise 1



In your own words, name the key goal of Courage and the process we use to get there.

```{r courage-1}
question_text(NULL,
	message = "Courage selects the data generating mechanism. We first specify the mathematical formula which connects the outcome variable we are interested in with the other data that we have. We explore different models. We need to decide which variables to include and to estimate the values of unknown parameters. We check our models for consistency with the data we have. We avoid hypothesis tests. We select one model.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

### Exercise 2

Load the **brms** package.

```{r courage-2, exercise = TRUE}

```

```{r courage-2-hint-1, eval = FALSE}
library(...)
```

```{r courage-2-test, include = FALSE}
library(brms)
```



### Exercise 3

Load the **tidybayes** package.

```{r courage-3, exercise = TRUE}

```

```{r courage-3-hint-1, eval = FALSE}
library(...)
```

```{r courage-3-test, include = FALSE}
library(tidybayes)
```
 

### Exercise 4

Type `nes` below

```{r courage-4, exercise = TRUE}

```

```{r courage-4-hint-1, eval = FALSE}
nes
```

### 

We can see there is a lot of data that we do not need to use for our model, therefore, we need to filter some of it out.

### Exercise 5

Pipe `filter()` to nes and set the argument `year` to `1992` 

```{r courage-5, exercise = TRUE}

```

```{r courage-5-hint-1, eval = FALSE}
nes |> filter(...)
```

### 

This only looks at data from the year 1992.

### Exercise 6

Continue the pipe with `select()`, be sure to select the `pres_vote` and `sex` columns

```{r courage-6, exercise = TRUE}

```

```{r courage-6-hint-1, eval = FALSE}
nes |> ... |> select(...)
```

### 

This only keeps the data that we need, which is the candidate voted and the sex of the voter.


### Exercise 7

Continue the pipe with `drop_na()`

```{r courage-7, exercise = TRUE}

```

```{r courage-7-hint-1, eval = FALSE}
nes |> ... |> drop_na()
```

### 

This gets rid of NA values

### Exercise 8

Finish the pipe with `mutate()`. Set the `pres_vote` argument to `case_when()`. Inside of `case_when()`, change `pres_vote` from the name of the political party to the name of the candidate that was voted. (Look in the textbook to find the associated political parties)

```{r courage-8, exercise = TRUE}

```

```{r courage-8-hint-1, eval = FALSE}
... |> 
  mutate(pres_vote = case_when(
    pres_vote == "Democrat" ~ ...,
    pres_vote == ... ~ "Bush",
    pres_vote == ... ~ ..,
  ))
```


### Exercise 9

Set this equal to a new object called `nes_92`

```{r courage-9, exercise = TRUE}

```

```{r courage-9-hint-1, eval = FALSE}
nes_92 <- ...
```

### 

This is the data we will use to create our model

### Exercise 10

Create a model using `brm()` from the **brms** package. Your arguments should be: `formula = pres_vote ~ sex`, `data = nes_92`, `family = categorical()`, `silent = 2`, `refresh = 0` and `seed = 76`


Assign the result to an object called `fit_nes`.

```{r courage-10, exercise = TRUE}

```

```{r courage-10-hint-1, eval = FALSE}
fit_nes <- brm(... = pres_vote ~ sex,
               ... = nes_92,
               ... = categorical(),
               silent = ...,
               refresh = ...,
               seed = ...)
```



### Exercise 11

Type `fit_nes` and hit "Run Code." This generates the same results as using `print(fit_nes)`.

```{r courage-11, exercise = TRUE}

```

```{r courage-11-hint-1, eval = FALSE}
print(...)
```

```{r courage-11-test, include = FALSE}
print(fit_nes)
```


### Exercise 12

Run `family()` on `fit_nes`. `family()` provides information about the "family" of the error term and the link between it and the dependent variable.


```{r courage-12, exercise = TRUE}

```

```{r courage-12-hint-1, eval = FALSE}
family(...)
```

```{r courage-12-test, include = FALSE}
family(fit_nes)
```

### 

<!-- TJ: Is this a good explanation?. -->

In this case, `fit_nes` is in the `categorical` family.

### Exercise 13

Run `formula()` on `fit_nes`. `formula()` returns the statistical equation which relates the dependent variable to the independent variable(s).


```{r courage-13, exercise = TRUE}

```

```{r courage-13-hint-1, eval = FALSE}
formula(...)
```

```{r courage-13-test, include = FALSE}
formula(fit_nes)
```

### 

In this case, the formula is `pres_vote ~ sex`. We are finding the correlation between the independant variable (`sex`) and the dependant variable (`pres_vote`)

### Exercise 14

Run `nobs()` on `fit_nes`. The `nobs()` function returns the **n**umber of **obs**ervations.

```{r courage-14, exercise = TRUE}

```

```{r courage-14-hint-1, eval = FALSE}
nobs(...)
```

```{r courage-14-test, include = FALSE}
nobs(fit_nes)
```

### 

In this case, `fit_nes` has 1658 recorded observations

### Exercise 15

Run `posterior_interval()` on `fit_nes`. The `posterior_interval()` function returns 95% intervals for all the parameters in our model.

```{r courage-15, exercise = TRUE}

```

```{r courage-15-hint-1, eval = FALSE}
posterior_interval(...)
```

```{r courage-15-test, include = FALSE}
posterior_interval(fit_nes)
```

### 

<!---TJ: Not sure what to put for a knowledge drop here--->


### Exercise 16

Run `fixef()` on `fit_nes`. The `fixef()` returns information about the **fix**ed **ef**fects in the model.

```{r courage-16, exercise = TRUE}

```

```{r courage-16-hint-1, eval = FALSE}
fixef(...)
```

```{r courage-16-test, include = FALSE}
fixef(fit_nes)
```

### 

<!---TJ: Not sure what to put for a knowledge drop here--->

### Exercise 17

Run `pp_check()` on `fit_nes`. The `pp_check()` runs a **p**osterior **p**redictive check.

```{r courage-17, exercise = TRUE}

```

```{r courage-17-hint-1, eval = FALSE}
pp_check(...)
```

```{r courage-17-test, include = FALSE}
pp_check(fit_nes)
```

### 

`pp_check()` is used to examine if the “fake data” created from our DGM matches our actual data. We see that the "fake data" does indeed match our real data.


### Exercise 18

Use `library()` to load the [**gtsummary**](https://www.danieldsjoberg.com/gtsummary) package.

```{r courage-18, exercise = TRUE}

```

```{r courage-18-hint-1, eval = FALSE}
library(gtsummary)
```

```{r courage-18-test, include = FALSE}
library(gtsummary)
```

### 

<!-- TJ: Need some help with this -->

### Exercise 19

<!-- DK: This can be just one question or several, especially if you want to teach some more gtsummary or gt tricks. Note that you need to adjust the test to make sure it works. -->


Run `tbl_regression()` on `fit_nes`.




```{r courage-19, exercise = TRUE}

```

```{r courage-19-hint-1, eval = FALSE}
tbl_regression(...)
```

```{r courage-19-test, include = FALSE}
tbl_regression(fit_nes)
```

### 

<!-- DK: Give something like the same sentence which you want the students to use at the end of the next question. -->


### Exercise 20

Write a few sentence which summarize your work so far. The first few sentences are the same as what you had at the end of the Justice Section. Add at least one sentence which describes the modelling approach which you are using, specifying at least the functional form and the dependent variable. Add at least one sentence which describes the *direction* (not the magnitude) of the relationship between one of your independent variables and your dependent variable.

```{r courage-20}
question_text(NULL,
	message = "Using data from the National Election Studies (NES) survey of US citizens, we seek to understand the relationship between voter preference and sex in the 1992 Presidential election. Our results might be biased by differential non-response among different categories of voters.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

<!---TJ: need help w last sentence --->

### 

## Temperance
### 

*Temperance is a tree which as for its root very little contentment, and for its fruit calm and peace.* - Buddha



### Exercise 1

In your own words, describe the use of Temperance in finishing your data science project.

```{r temperance-1}
question_text(NULL,
	message = "Temperance guides us in the use of the data generating mechanism --- or the 'model' ---  we have created to answer the questions with which we began. We create posteriors for the quantities of interest.",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### Exercise 2

Recall the question with which we began:

> What was the relationship between sex and voting in the 1992 US Presidential election?

<!--- TJ: What do i pipe it to? --->

Pipe `fit_nes` to . . .

```{r temperance-2, exercise = TRUE}

```

```{r temperance-2-hint-1, eval = FALSE}

```

```{r temperance-2-test, include = FALSE}

```

### 


### Exercise 3

Write a paragraph which summarizes the project in your own words. The first few sentences are the same as what you had at the end of the Courage Section. But, since your question may have evolved, you should feel free to change those sentences. Add at least one sentence which describes at least one quantity of interest (QoI) --- presumably one that answers your question -- and which provides a measure of uncertainty about that QoI.


```{r temperance-3}
question_text(NULL,
	message = "XX",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

### Exercise 4

Write a few sentences which explain why the estimates for the quantities of interest, and the uncertainty thereof, might be wrong. Suggest an alternative estimate and confidence interval.

```{r temperance-4}
question_text(NULL,
	message = "XX",
	answer(NULL, correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

## Summary
### 

This tutorial covered [Chapter 8: Four Parameters: Categorical](https://ppbds.github.io/primer/XX.html) of [*Preceptor’s Primer for Bayesian Data Science: Using the Cardinal Virtues for Inference*](https://ppbds.github.io/primer/) by [David Kane](https://davidkane.info/). 




```{r download-answers, child = system.file("child_documents/download_answers.Rmd", package = "tutorial.helpers")}
```
