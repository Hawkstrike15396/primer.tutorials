---
title: 'Visualization: Tidyverse'
author: Heather Li and Yuhan Wu
tutorial:
  id: visualization-tidyverse
output:
  learnr::tutorial:
    progressive:  true
    allow_skip::  true
runtime: shiny_prerendered
description: Overview of the most important commands in the Tidyverse.
---

<!-- Change in plans! Make each Section follow the equivalent section in R for Data Science, going question by question. In other words, rewrite this whole tutorial, so that each section goes through every command which is used in the relevant R for Data Science 2e section, with knowledge drops taken from the book or from the help page. Just do filter(), select() and mutate() for now. Maybe keep glimpse() and other look at the data questions. -->


<!-- Example sections require the use of multiple commands in a chain. --> 


```{r setup, include = FALSE}
library(learnr)
library(all.primer.tutorials)
library(tidyverse)
library(primer.data)
library(learnr)
library(nycflights13)

knitr::opts_chunk$set(echo = FALSE)
options(tutorial.exercise.timelimit = 60, 
        tutorial.storage = "local") 
```

```{r copy-code-chunk, child = system.file("child_documents/copy_button.Rmd", package = "tutorial.helpers")}
```

```{r info-section, child = system.file("child_documents/info_section.Rmd", package = "tutorial.helpers")}
```

## Introduction
### 

This tutorial will walk you through some of the major functions in the **[tidyverse](https://www.tidyverse.org/)** package, including functions like `filter()` and `select()` that are useful for data manipulation, as well summary functions like `mean()` and `median()` which are important for statistical analysis.



## `filter()`
### 

Let's practice how to use `filter()` tibbles to include only the rows with attributes we want to see. 



### Exercise 1

Use `glimpse()` to look at the data set `flights`.

```{r filter-1, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r filter-1-hint-1, eval = FALSE}
glimpse(flights)
```

### 

### Exercise 2

The `filter()` function displays rows that meet specific criteria. To find all flights that arrived more than 120 minutes, create a pipe using the "flights" tibble and apply "filter()". For the arguement, use dep_delay as variable and use the greater than condition.

```{r filter-2, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r filter-2-hint, eval = FALSE}
flights |>
  filter(dep_delay>...)

```

In `filter()`, we can use symbols like `<`,`>`,`==`,`>=`,`<=` to search for specific rows in a dataset. Filter does not alter the original data, it only selects rows based on the criteria given.

###
### Exercise 3

To find flights on January 1st, we need to modify the previous code by changing the argument in "filter()". We can add two variables, "month" and "day", to specify the date we want to filter. To get the flights on January 1st, we can use the "and" operator & to filter the data for the first month and the 1st day.

```{r filter-3, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r filter-3-hint, eval = FALSE}
...|>
  filter(... == 1 & day == ...)
```



###
### Exercise 4
To filter flights for either January or the first day of any month, we can use the "or" operator |. To implement this, we can add two arguments for "month" and set the first one to January (month 1) and the second one to any other desired month (month 2).

```{r filter-4, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r filter-4-hint, eval = FALSE}
flights |>
  filter(... == 1 | month == ...)
```
If you want to filter a data frame by group without having to create seperate data framers for each group, then use the ".by" argument in the `filter()` function which can  refer to the grouping variables when filtering a data frame by group.


###

### Exercise 5
To use both the "|" and "&" operators together, you can use the shortcut "%in%". To do this, you can copy the previous code and replace "|" with "%in%" and convert the values into a vector using "c()".

```{r filter-5, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r filter-5-hint, eval = FALSE}
flights |> 
  filter(month ... c(1, 2))
```
Another shortcut that looks like this that works for pipe operator is "%>%" and this allows you to chain multiple operations together in a single line of code, which can make your code more readable and easier to understand.


###


Good Work!!



## `select()`
### 

<!-- DK: Not a good intro. Include: https://dplyr.tidyverse.org/reference/select.html -->

Let's practice how to use `select()` on tibbles to include only the columns which we want to see.  

### Exercise 1

The `select()` function lets you select columns by typing down the name of the columns. Start a pipe with flights and use `select()` and select the year, month, and day column.
```{r select-1, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r select-1-hint, eval = FALSE}
flights |> 
  select(year, month, day)
```
If you want to choose columns based on the beginning letters of their names, use `starts_with()` within `select()`.

###

### Exercise 2

To select a range of columns without specifying each name individually in the `select()` function, use a colon to separate the first and last columns in the range. For instance, to select columns between year and day, use `select(year:day)`.

```{r select-2, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r select-2-hint, eval = FALSE}
flights |> 
  select(...:day)
```
If you want to select a column based on the ending alphabets of a column name then use `ends_with()`.

###

### Exercise 3

To select all columns except for those between year and day (inclusive), use the `!` symbol within the `select()` function to exclude those columns.
```{r select-3, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r select-3-hint, eval = FALSE}
... |> 
  select(...:day)
```
If you want to select a column based on the alphabets you want, then use `contains()` to do so.

###

### Exercise 4

To select columns of type character, you can use `where(is.character)` within the `select()` function. So, update the code to include only those columns that are of type character.
```{r select-4, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r select-4-hint, eval = FALSE}
... |> 
  ...(where(is.character))

```
To select columns that follow a pattern of starting with the same letters and a range of numbers, you can use `num_range()`. For example, `num_range("x", 1:3)` selects columns x1, x2, and x3.


Good Work!!



###










## `mutate()`
### 

Let's practice how to use `mutate()` on tibbles to add new columns that are calculated from existing columns. 



### Exercise 1

The `mutate(`) function in R offers a wide range of options to manipulate various types of values. For the purposes of this section, we will be using basic algebraic operations.

To begin, let's create a new pipe that takes the `flights` data and pipes it into the `mutate()` function. Within `mutate()`, we will create a new column called "gain," which will be calculated by subtracting the arrival delay (`arr_delay`) from the departure delay (`dep_delay`). This will give us an estimate of how much time a delayed flight was able to make up while in the air.
```{r mutate-1, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r mutate-1-hint, eval = FALSE}
flights |> 
  ...(
    gain = ... - arr_delay
  )

```

###


### Exercise 2

Now that we've calculated how much time a delayed flight was able to make up in the air, let's determine its speed in miles per hour. To do this, we can copy the previous code and add a new column called `speed`. We'll then set the value of `speed` to be equal to the distance (`distance`) divided by the air time (`air_time`) multiplied by 60, which will give us the speed in miles per hour.
```{r mutate-2, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r mutate-2-hint, eval = FALSE}
... |> 
  mutate(
    gain = dep_delay - arr_delay,
    ... = distance / ... * 60
  )
```

###

### Exercise 3

After running the code, `mutate()`, by default will add new columns on the right hand side of your data set which makes it difficult to see what's happening to data set. TO make it easier, we can use `.before` argument to add the new column to the left hand side(the first column). Go ahead and make the change and see the change.
```{r mutate-3, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r mutate-3-hint, eval = FALSE}
flights |> 
  mutate(
    gain = dep_delay - ...,
    speed = ... / air_time * 60,
    .... = 1
  )
```

###

### Exercise 4

Alternative to `.before`, we could use the `.keep` arguemnt and set it to `used` to only display the variable used with the whole `mutate()` function. 
```{r mutate-4, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r mutate-4-hint, eval = FALSE}
flights |> 
  mutate(
    gain = ... - arr_delay,
    ... = air_time / 60,
    gain_per_hour = gain / ...,
    .keep = "used"
  )
```

###







Good work. 

## Summary functions
### 

<!-- DK: Does not have an equivalent in R4DS. -->

You will practice using summary functions in R. You will learn practice how to handle missing values in a data set. 

### Exercise 1

Recall that we use the `$` operator to extract a column as a vector. Extract the column `age` from `trains`. 

```{r summary-functions-1, exercise = TRUE}

```

```{r summary-functions-1-hint-1, eval = FALSE}
trains$age
```

 
### Exercise 2

Use the `mean()` function to find the mean of the `age` column in `trains`. 


```{r summary-functions-2, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy to use previous code</button>

```{r summary-functions-2-hint-1, eval = FALSE}
mean(trains$age)
```

### Exercise 3

Find the `median()` of the `age` column in `trains`.


```{r summary-functions-3, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy to use previous code</button>

```{r summary-functions-3-hint-1, eval = FALSE}
median(...)
```

### 

We do not pipe summary functions together because they do not refer to each other. The function `mean()` is not performed on any data piped into it but on the object `trains$age`. 

### Exercise 4

Use the `min()` function to find the minimum of the column `age`.


```{r summary-functions-4, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy to use previous code</button>

```{r summary-functions-4-hint-1, eval = FALSE}
min(...)
```

### Exercise 5

Find the `max()` of the column `age` in trains. 


```{r summary-functions-5, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy to use previous code</button>

```{r summary-functions-5-hint-1, eval = FALSE}
max(...)
```

### Exercise 6

Now, try to find the `mean()` of the `pulse` column in the  `nhanes` data set. The result will be `N/A`, because these data have missing values. 


```{r summary-functions-6, exercise = TRUE}

```

```{r summary-functions-6-hint-1, eval = FALSE}
mean(nhanes$pulse)
```

### Exercise 7

Try again to find the `mean()` of the `pulse` column. To remove missing values add the argument `na.rm` and set it equal to `TRUE`. 


```{r summary-functions-7, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy to use previous code</button>

```{r summary-functions-7-hint-1, eval = FALSE}
mean(..., na.rm = TRUE)
```

### 

`na.rm` stands for N/A **r**e**m**ove.

### Exercise 8

Let's try to use multiple summary functions at once. Use `c()` to make a vector that finds the `mean()` and `median()` of `pulse`.


```{r summary-functions-8, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy to use previous code</button>

```{r summary-functions-8-hint-1, eval = FALSE}
Remember to set na.rm = TRUE in both functions. 
```

```{r summary-functions-8-hint-2, eval = FALSE}
c(median(..., na.rm = TRUE), 
  mean(..., na.rm = TRUE))
```

### Exercise 9

The function `quantile()` allows us to calculate percentiles of data. Let's calculate the 1st, 50th and 99th percentiles of the `pulse` column. The first argument is the vector of data for which we want to calculate, the second argument `probs` is set equal to a vector of the percentiles we want in decimal form.


```{r summary-functions-9, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy to use previous code</button>

```{r summary-functions-9-hint-1, eval = FALSE}
Remember to include the argument, na.rm = TRUE
```

```{r summary-functions-9-hint-2, eval = FALSE}
quantile(nhanes$pulse,
         probs = c(.01, .5, .99), 
         na.rm = TRUE)
```

### Exercise 10

The functions `mad()` and `sd()` calculate the median absolute deviation and the standard deviation, both of which are measures of how spread out a function is from a central point, the median and mean, respectively. In many data sets, these values are similar. Click to continue to the exercise. 

### 

Make a vector that finds both the `mad()` and `sd()` of the `pulse` column. 


```{r summary-functions-10, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy to use previous code</button>

```{r summary-functions-10-hint-1, eval = FALSE}
Remember to include the third argument, na.rm = TRUE in both functions. 
```

```{r summary-functions-10-hint-2, eval = FALSE}
c(mad(..., na.rm = ...), 
  sd(..., na.rm = ...))
```

Good work. 

## `summarize()` 
### 

You will learn about the `summarize()` function, which creates new tibbles with summary information of our data. 

### Exercise 1

Start a pipe with `trains`. Use `mutate()` to create a new column called `att_change` whose values is the difference between `att_end` and `att_start`. 

```{r summarize-1, exercise = TRUE}

```

```{r summarize-1-hint-1, eval = FALSE}
trains |> 
  mutate(... = att_end - att_start)
```

### Exercise 2

Copy/paste your code. The function `summarize()` is similar to `mutate()` but creates its new column in a summary table. Within the function `summarize()`, create a column named `mean_change` and set it to the `mean()` of `att_change`. 


```{r summarize-2, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy to use previous code</button>

```{r summarize-2-hint-1, eval = FALSE}
trains |> 
  mutate(att_change = att_end - att_start) |> 
  summarize(mean_change = mean(...))
```

### Exercise 3

Copy/paste your code before the summarize function, i.e. the code in Exercise 1. `summarize()` can create a tibble with more than one new column.  Within the function `summarize()`, create a column named `mean_change` and set it to the `mean()` of `att_change` and create a column named `max_change` and set it to the `max()` of `att_change`. 


```{r summarize-3, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy to use previous code</button>

```{r summarize-3-hint-1, eval = FALSE}
... |> 
  summarize(mean_change = mean(...), 
            max_change = max(...))
```

### 

`summarize()` must be piped directly after a tibble that has the data you want to summarize. Piping one `summarize()` function after another does not create a bigger `summarize()` table, but gives an error.

### Exercise 4

Copy/paste your code before the `summarize()` function. You can make summarize columns without assigning them names. Run the `summarize()` function with only the arguments, `mean(att_change)` and `max(att_change)`. 


```{r summarize-4, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy to use previous code</button>

```{r summarize-4-hint-1, eval = FALSE}
... |> 
  summarize(mean(...), 
            max(...))
```

### 

If no names are given, `summarize()` will simply use the arguments as names. 

### Exercise 5

`summarize()` is not limited to just summary functions. Start a new pipe with `trains`. Use `summarize()` to create tibble with two new columns: the first, `avg_hisp_perc_scaled` which is equal to the `mean()` value of `hisp_perc` times 100; the second, `median_hisp_perc_scaled` which is equal to the `median()` value of `hisp_perc` times 100. The results will be N/A because `hisp_perc` has missing values. 


```{r summarize-5, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy to use previous code</button>

```{r summarize-5-hint-1, eval = FALSE}
... |> 
  summarize(avg_hisp_perc_scaled = mean(hisp_perc) * ...,
            median_hisp_perc_scaled = median(hisp_perc) * ...)
```

### Exercise 6

Copy/paste the code above. Add `na.rm` in both the `median()` and `mean()` functions


```{r summarize-6, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy to use previous code</button>

```{r summarize-6-hint-1, eval = FALSE}
... |> 
  summarize(avg_hisp_perc_scaled = mean(hisp_perc, na.rm = TRUE) * ...,
            median_hisp_perc_scaled = median(hisp_perc, na.rm = TRUE) * ...) 
```

### Exercise 7

Start a new pipe with `trains`. Use `summarize()` to make a tibble with a new column called `ideology_quantiles` which contains the 1st, 50th, and 99th percentiles of `ideology_start`. 


```{r summarize-7, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy to use previous code</button>

```{r summarize-7-hint-1, eval = FALSE}
Remember to write probabilities in decimal form. 
```

```{r summarize-7-hint-2, eval = FALSE}
... |> 
  summarize(ideology_quantiles = quantile(ideology_start, 
                                          probs = c(..., ..., ...)))
```

### 

The summarize table should have three rows, the first corresponding to the first one of our percentiles, and so on. 

### Exercise 8

Though we know what percentiles we have calculated, this information is not in the tibble. Start a new pipe with `trains`. Use `summarize()` to make a tibble with two new columns: the first, `ideology_quantiles` which contains the 1st, 50th, and 99th percentiles of `ideology_start`; the second `percentiles` which is equal to the vector `c("1st", "50th", "99th")`.


```{r summarize-8, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy to use previous code</button>

```{r summarize-8-hint-1, eval = FALSE}
... |> 
  summarize(ideology_quantiles = quantile(ideology_start, 
                                          probs = c(..., ..., ...)),
            percentiles = c("...", "...", "..."))
```

### 

`summarize()`, like `mutate()`, can also create a new column which has nothing to do with the data, as we have done here with the `percentiles` column. 

### 

Good work. 

## `summarize()` with `.by`
### 

<!-- DK: This section should be expanded. -->

More commonly, we use `summarize()` to produce summary statistics not for the whole data, but for groups of data. 

### Exercise 1

Run `trains` to view the tibble. 

```{r summarize-with-by-1, exercise = TRUE}

```

### 

Notice the box in the upper left-hand corner where the dimensions are displayed. 

### Exercise 2

Copy/paste your code. Use `summarize()` to make a tibble with two new columns: the first, `avg_att_start` which contains the `mean()` of `att_start`; the second, `avg_att_end` which contains the `mean()` of `att_end`. 


```{r summarize-with-by-2, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy to use previous code</button>

```{r summarize-with-by-2-hint-1, eval = FALSE}
... |>
  summarize(... = mean(att_start), 
            ... = mean(...))
```

### 

These are averages for the whole tibble. But what if want averages for each gender separately? For that, we use the `.by` argument to `summarize()`.

### Exercise 3

Copy/paste your code. Add a `.by` argument with the value set to `gender`. 


```{r summarize-with-by-3, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy to use previous code</button>

```{r summarize-with-by-3-hint-1, eval = FALSE}
... |>
  summarize(avg_att_start = mean(att_start), 
            avg_att_end = mean(att_end),
            .by = ...)
```

### 

In older R code, you may see the use of `group_by()` to accomplish this task. However, in new code, you should not use `group_by()` unless you have a very good reason to do so. 



## Summary
### 

<!-- Yuhan: Need Grammar review.  -->

These functions often look simple but are strong enough to handle almost all data sets with the help of several other functions. These functions you've learned in this chapter will becomes your friend in your exploration of R and data science. Good luck!

```{r download-answers, child = system.file("child_documents/download_answers.Rmd", package = "tutorial.helpers")}
```
