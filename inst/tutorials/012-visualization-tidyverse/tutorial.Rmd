---
title: 'Visualization: Tidyverse'
author: Heather Li and Yuhan Wu
tutorial:
  id: visualization-tidyverse
output:
  learnr::tutorial:
    progressive: yes
    allow_skip: yes
runtime: shiny_prerendered
description: Overview of the most important commands in the Tidyverse.
---

<!-- Example sections require the use of multiple commands in a chain. --> 


```{r setup, include = FALSE}
library(learnr)
library(primer.tutorials)
library(tidyverse)
library(primer.data)
library(learnr)

knitr::opts_chunk$set(echo = FALSE)
options(tutorial.exercise.timelimit = 60, 
        tutorial.storage = "local") 
```

```{r copy-code-chunk, child = "../../child_documents/copy_button.Rmd"}
```

```{r info-section, child = "../../child_documents/info_section.Rmd"}
```

## Introduction
### 

<!-- Yuhan: Add Introduction -->
<!-- Yuhan: Maybe change to  **[tidyverse](https://dplyr.tidyverse.org/)** to better match the content. If done so consider changing the name. -->

This tutorial will walk you through some of the major functions in the **[tidyverse](https://www.tidyverse.org/)** package, including functions like `filter()` and `select()` that are useful for data manipulation, as well summary functions like `mean()` and `median()` which are important for statistical analysis.



## `filter()`
### 

Let's practice how to use `filter()` tibbles to include only the rows with attributes we want to see. 

### Exercise 1

Use `glimpse()` to look at the data set `cces`.


```{r filter-1, exercise = TRUE}

```

### Exercise 2

Start your code with `cces`. Use the pipe operator `|>` to add the function `filter()`. Within `filter()` use the argument to select the rows where `state` is equal to "Massachusetts". To set something equal to a value in `filter` use two equal signs, `==`.


```{r filter-2, exercise = TRUE}

```

```{r filter-2-hint-1, eval = FALSE}
cces |> 
  filter(state == "...")
```

### 

`==` is used because it is **checking** whether the value is equal, while `=` is used to set something equal to something else. 

The pipe operator is used very often but is inconvenient to type. The keyboard shortcut "`ctrl` (Mac: `command`) +`shift` + `M`" makes the pipe operator. Get used to using this shortcut. 

### Exercise 3

Great. Copy/paste your code from above. Let's now extend our code within `filter()` to include rows where `state` is "Massachusetts" AND where `ideology` is "Liberal". Use the "and operator" `&` to separate the conditions. 


```{r filter-3, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy to use previous code</button>

```{r filter-3-hint-1, eval = FALSE}
cces |> 
  filter(state == "..." &
        ideology == "...")
```

### 

Note that we maintain our `cces |>` which allows `filter()` to know the data that it manipulates with. It is also possible to not use the `|>` operator, just include the data frame `filter()` needs to deal with as the first argument in within the parentheses. For example:  `filter(cces,state == "Massachusetts" & ideology == "Liberal")`

<!-- DK: Add some knowledge -->

### Exercise 4

Start a new pipe with `cces`. Use `filter()` to include data  where both `gender` is "Male" and `age` is greater than or equal to 40. Instead of using `&` to separate the two conditions, use a comma. 

### 

```{r filter-4, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy to use previous code</button>

```{r filter-4-hint-1, eval = FALSE}
cces |> 
  filter(gender == "...",
           age >= 40)
```

### 

Using a comma to separate arguments in `filter()` is equivalent to using `&`. The command above returns a tibble of males who are also older than 40. 

You do not need to write `40` in quotation marks because it is an integer variable, not a character variable. The same goes for all numeric variable types (dbl, numeric). You can see a variable's type under the column in brackets. 

### Exercise 5

Start a new pipe with `cces`. `filter()`  the data for rows where `gender` is "Male" OR `age` is greater than or equal to 40. Use the "or operator" `|` to separate the conditions. 


```{r filter-5, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy to use previous code</button>

```{r filter-5-hint-1, eval = FALSE}
cces |> 
  filter(gender == "..." |
           age >= ...)
```

### 

This tibble has more than twice as many rows as the previous command. In addition to all the rows in the preceeding tibble, it also includes men who are younger than 40 and women over the age of 40. 

### Exercise 6

Copy/paste your code from above. Let's organize the tibble by values of `age` in ascending order. Extend your code with `|>` and use the function `arrange()`. 


```{r filter-6, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy to use previous code</button>

```{r filter-6-hint-1, eval = FALSE}
cces |> 
  ... |>
  arrange(age)
```

### 

Everyone in the first few rows should be 18. Everyone will also be male because of the way we have filtered the data. 

We do not use quotes for the argument of `arrange()`, because it is a column that exists in our data frame. This is the case for most functions which take an existing column as an argument. 

### Exercise 7

Copy/paste your code from above. Now let's organize the tibble by values of `age` in descending order. Extend your code with `|> ` and use `arrange(desc())`.


```{r filter-7, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy to use previous code</button>

```{r filter-7-hint-1, eval = FALSE}
cces |> 
  ... |>
  arrange(desc(age))
```

### Exercise 8

Start a new pipe with `cces`. Instead of just those who live in Massachusetts and have liberal ideology, let's filter the data to those who live in either Massachusetts, New Hampshire, or Vermont and have liberal ideology. Let's start with the states. While we could type `state == "..."` separated by `|` three times, this is cumbersome. Instead we can use a vector with the three state names `c("Massachusetts", "New Hampshire", "Vermont")` and the `%in%` operator in place of the `==`. 

```{r filter-8, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy to use previous code</button>

```{r filter-8-hint-1, eval = FALSE}
cces |> 
  filter(state %in% c("...", "...", "..."))
```

### 

Using the `==` will return a tibble but NOT the tibble with the results you are looking for. When filtering for any of several terms in a vector, always use  `%in%`.

### 

We use the `!=` to reverse the results of the `==`, i.e. to include everything except what is in the condition. We cannot do the same by adding an exclamation directly in front of the `%in%` operator. Instead, we would type  `filter(!(state %in% c("Massachusetts", "New Hampshire", "Vermont)))`. Enclosing any condition within `!()` would have the same effect. 

### Exercise 9

Copy/paste your code from above. Add a new condition with a comma, and use `filter()` the data so that we keep rows whose `ideology` is "Liberal". 


```{r filter-9, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy to use previous code</button>

```{r filter-9-hint-1, eval = FALSE}
cces |> 
  filter(state %in% c("...", "...", "..."),
         ideology == "Liberal")
```

### Exercise 10

Copy/paste the code above. Let's filter our data to just the 200 youngest liberals who live in these three states. First, continue your pipe with `|>` and use `arrange()` to arrange by age from youngest to oldest. 


```{r filter-10, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy to use previous code</button>

```{r filter-10-hint-1, eval = FALSE}
cces |> 
  filter(state %in% c("...", "...", "..."),
         ideology == "...") |> 
  arrange(age)

```

### Exercise 11

Because of the way we have arranged the data, the 200 rows with the lowest age value would be the first 200. Copy/paste your code from above. Continue your pipe with `|>` and use `slice()` to make a tibble of only the first two hundred rows. 


```{r filter-11, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy to use previous code</button>

```{r filter-11-hint-1, eval = FALSE}
Within `slice()` use the argument 1:200
```

```{r filter-11-hint-2, eval = FALSE}
cces |> 
  filter(state %in% c("Massachusetts", "New Hampshire", "Vermont"),
  ideology == "Liberal")|>
  arrange(age)|>
  slice(1:200)
```

### 

`slice(200)` instead of `slice(1:200)` will return a tibble which contains only the 200th row. 

Remember that the `:` operator represents a consecutive series, in this case of integers from 1 to 200. 

### 

Good work. 

## `select()`
### 

Let's practice how to use `select()` tibbles to include only the columns which we want to see.  

### Exercise 1

Use `glimpse()` to look at the data set `shaming`.


```{r select-1, exercise = TRUE}

```

### Exercise 2

Let's make a tibble with just the columns `sex` and `age`. Use the function `select()` which takes the column names as arguments, separated by a comma. 

```{r select-2, exercise = TRUE}

```

```{r select-2-hint-1, eval = FALSE}
shaming |> 
  select(sex, age)
```

### 

`select()` will produce the columns of the new tibble in the order specified within the function. 

As we have seen in other functions, names of existing columns does not use quatation marks.

### Exercise 3

Start a new pipe with `shaming`. The `tidyverse` uses several tools to make selecting columns easier. Use `select()` and `:` to select the columns `primary_00`, `general_00`, `primary_02`, `general_02`, `primary_04`, `general_04`. 


```{r select-3, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy to use previous code</button>

```{r select-3-hint-1, eval = FALSE}
As with integers, : defines a consectuive series using the first and last terms of the series. 
```

```{r select-3-hint-2, eval = FALSE}
shaming |> 
  select(primary_00:general_04)
```

### 

Notice that when selecting, unlike when filtering, R will try to suggest column names as you type. 

### Exercise 4

The `tidyverse` uses several tools to make selecting groups of columns easier. Start a new pipe with `shaming`. Use `select()` and within it the `starts_with()` helper function to select all the columns that begin with the string `"primary"`.


```{r select-4, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy to use previous code</button>

```{r select-4-hint-1, eval = FALSE}
shaming |> 
  select(starts_with("..."))
```

### 

We put `"primary"` in quotes because it is a string we are searching for, not the full name of an existing column.

### Exercise 5

Start a new pipe with `shaming`. Use `select()` and the helper function `contains()` to select all columns that contain an underscore `"_"`.


```{r select-5, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy to use previous code</button>

```{r select-5-hint-1, eval = FALSE}
shaming |> 
  select(contains("..."))
```

### 

There is a select helper function similar to `contains()` named `matches()`, which can take regular expressions with metacharacters as you have seen in Terminal with `grep`. 

### Exercise 6

Start a new pipe with `shaming`. First filter the data for rows in which the value of `primary_06` is equal to `1`.


```{r select-6, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy to use previous code</button>

```{r select-6-hint-1, eval = FALSE}
shaming |> 
  filter(primary_06 == ...)
```

### 

Remember that filter uses the `==` operator. 

### Exercise 7

Copy/paste your code. Now continue your pipe and select the `age` and `sex` columns. 


```{r select-7, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy to use previous code</button>

```{r select-7-hint-1, eval = FALSE}
shaming |> 
  filter(...) |>
  select(..., ...)
```

```{r select-7-hint-2, eval = FALSE}
shaming |> 
  filter(primary_06 == 1) |>
  select(age,sex)
```

### Exercise 8

Copy/paste your code. Now continue your pipe with the function `pull()` and set the `age` column as its argument. `pull()` selects a colimn and outputs its contents as a vector.


```{r select-8, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy to use previous code</button>

```{r select-8-hint-1, eval = FALSE}
... |> 
  pull(age)
```

### Exercise 9

Copy/paste your code. In front of `shaming` use the `<-` operator to assign the whole pipe to an object called `voter_ages`.


```{r select-9, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy to use previous code</button>

```{r select-9-hint-1, eval = FALSE}
voter_ages <- shaming |> 
  ... |> 
  pull(age)
```

This saves the output of all the code in the pipe, a vector of voter ages, to an object named `voter_ages`. 

### Exercise 10

Copy/paste your code. Do not continue your pipe with the pipe operator. Instead use the `mean()` function to find the mean of the vector `voter_ages`. 


```{r select-10, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy to use previous code</button>

```{r select-10-hint-1, eval = FALSE}
...
mean(voter_ages)
```

```{r select-10-hint-2, eval = FALSE}
voter_ages <- shaming |> 
  filter(primary_06 == 1) |>
  select(age,sex) |>
  pull(age)
 
 mean(voter_ages)
```

## `mutate()`
### 

### Exercise 1

Run `?trains` to open the help page for the data set `trains`. Read the description and peruse the column names. 

```{r mutate-1, exercise = TRUE}

```

### 

When not in a tutorial, the help page appears in the lower right corner of RStudio. 

### Exercise 2

We can also use `select()` to select columns that we want to exclude from our data. Every column that follows a `-` sign in will be excluded. Start your pipe with `trains`. Use `select()`, `-`, and a vector of the column names to exclude the columns `race`, `liberal`, `age`, `income`, `line`,  and `station`. 

```{r mutate-2, exercise = TRUE}

```

```{r mutate-2-hint-1, eval = FALSE}
... |> 
    select(-c(race, liberal, ..., ..., ..., ...))
```

### Exercise 3

The function `mutate` allows us to create new columns or change old ones by manipulating data in existing columns. Start a new pipe with `trains`. Use `mutate()` to make a new column called `age_scaled`, set this equal to the `age` column divided by 10.


```{r mutate-3, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy to use previous code</button>

```{r mutate-3-hint-1, eval = FALSE}
... |> 
  mutate(age_scaled = ... / ...)
```

### 

This new column does not affect the original data set `trains` unless you assign the new tibble to an object with the `<-` operator. If you were to assign it to the object `trains`, it would override the original object for your current R session. 

### Exercise 4

Copy/paste your code. Continue your pipe and use `mutate()` to create a new column called `att_change` which is equal to `att_end` minus `att_start`. 


```{r mutate-4, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy to use previous code</button>

```{r mutate-4-hint-1, eval = FALSE}
... |> 
  mutate(att_change = ... - ...)
```

### Exercise 5

Copy/paste your code. Let's create a new column that has the value `TRUE` when `party` is "Democrat" and `FALSE` when it is not. Continue your pipe and use `mutate()` to create a new column called `democrat`. Set `democrat` equal to an `if_else()` function. The first argument is the condition that determines your outputs, `party == "Democrat"`. The second and third arguments represents the output when the condition is true and false, respectively. Set these equal to `TRUE` and `FALSE`. 


```{r mutate-5, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy to use previous code</button>

```{r mutate-5-hint-1, eval = FALSE}
... |> 
  mutate(democrat = if_else(party == "Democrat", TRUE, FALSE))
```

### 

`TRUE` and `FALSE` should not be included in quotes. They are boolean type variables and can be used conveniently in many situations where character variables cannot.

### Exercise 6

Copy/paste your code. Continue your pipe and use `mutate()` to create a new column `big_hisp_perc` which returns `TRUE` when `hisp_perc` is greater than or equal to .04 and `FALSE` when it is not. 


```{r mutate-6, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy to use previous code</button>

```{r mutate-6-hint-1, eval = FALSE}
... |> 
  mutate(big_hisp_perc = if_else(hisp_perc > .04, TRUE, FALSE))
```

### 

Do not forget to close both opening parentheses. 

### Exercise 7

Copy/paste your code. To use mutate to edit an existing column, make the "new column" the same name as the old one. Let's make a new  `treatment` column to have value `"T"` if `treatment` is equal to `"Treated"` and `"C"` when it is not. 


```{r mutate-7, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy to use previous code</button>

```{r mutate-7-hint-1, eval = FALSE}
... |> 
  mutate(treatment = if_else(treatment == "Treated", "T", "C"))
```

Good work. 

## Summary functions
### 

You will practice using summary functions in R. You will learn practice how to handle missing values in a data set. 

### Exercise 1

Recall that we use the `$` operator to extract a column as a vector. Extract the column `age` from `trains`. 

```{r summary-functions-1, exercise = TRUE}

```

```{r summary-functions-1-hint-1, eval = FALSE}
trains$age
```

 
### Exercise 2

Use the `mean()` function to find the mean of the `age` column in `trains`. 


```{r summary-functions-2, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy to use previous code</button>

```{r summary-functions-2-hint-1, eval = FALSE}
mean(trains$age)
```

### Exercise 3

Find the `median()` of the `age` column in `trains`.


```{r summary-functions-3, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy to use previous code</button>

```{r summary-functions-3-hint-1, eval = FALSE}
median(...)
```

### 

We do not pipe summary functions together because they do not refer to each other. The function `mean()` is not performed on any data piped into it but on the object `nhanes$pulse`. 

### Exercise 4

Use the `min()` function to find the minimum of the column `age`.


```{r summary-functions-4, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy to use previous code</button>

```{r summary-functions-4-hint-1, eval = FALSE}
min(...)
```

### Exercise 5

Find the `max()` of the column `age` in trains. 


```{r summary-functions-5, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy to use previous code</button>

```{r summary-functions-5-hint-1, eval = FALSE}
max(...)
```

### Exercise 6

Now, try to find the `mean()` of the `pulse` column in the  `nhanes` data set. The result will be `N/A`, because these data have missing values. 


```{r summary-functions-6, exercise = TRUE}

```

```{r summary-functions-6-hint-1, eval = FALSE}
mean(nhanes$pulse)
```

### Exercise 7

Try again to find the `mean()` of the `pulse` column. To remove missing values add the argument `na.rm` and set it equal to `TRUE`. 


```{r summary-functions-7, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy to use previous code</button>

```{r summary-functions-7-hint-1, eval = FALSE}
mean(..., na.rm = TRUE)
```

### 

`na.rm` stands for N/A **r**e**m**ove.

### Exercise 8

Let's try to use multiple summary functions at once. Use `c()` to make a vector that finds the `mean()` and `median()` of `pulse`.


```{r summary-functions-8, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy to use previous code</button>

```{r summary-functions-8-hint-1, eval = FALSE}
Remember to set na.rm = TRUE in both functions. 
```

```{r summary-functions-8-hint-2, eval = FALSE}
c(median(..., na.rm = TRUE), 
  mean(..., na.rm = TRUE))
```

### Exercise 9

The function `quantile()` allows us to calculate percentiles of data. Let's calculate the 1st, 50th and 99th percentiles of the `pulse` column. The first argument is the vector of data for which we want to calculate, the second argument `probs` is set equal to a vector of the percentiles we want in decimal form.


```{r summary-functions-9, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy to use previous code</button>

```{r summary-functions-9-hint-1, eval = FALSE}
Remember to include the argument, na.rm = TRUE
```

```{r summary-functions-9-hint-2, eval = FALSE}
quantile(nhanes$pulse,
         probs = c(.01, .5, .99), 
         na.rm = TRUE)
```

### Exercise 10

The functions `mad()` and `sd()` calculate the median absolute deviation and the standard deviation, both of which are measures of how spread out a function is from a central point, the median and mean, respectively. In many data sets, these values are similar. Click to continue to the exercise. 

### 

Make a vector that finds both the `mad()` and `sd()` of the `pulse` column. 


```{r summary-functions-10, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy to use previous code</button>

```{r summary-functions-10-hint-1, eval = FALSE}
Remember to include the third argument, na.rm = TRUE in both functions. 
```

```{r summary-functions-10-hint-2, eval = FALSE}
c(mad(..., na.rm = ...), 
  sd(..., na.rm = ...))
```

Good work. 

## `summarize()` 
### 

You will learn about the `summarize()` function, which creates new tibbles with summary information of our data. 

### Exercise 1

Start a pipe with `trains`. Use `mutate()` to create a new column called `att_change` whose values is the difference between `att_end` and `att_start`. 

```{r summarize-1, exercise = TRUE}

```

```{r summarize-1-hint-1, eval = FALSE}
trains |> 
  mutate(... = att_end - att_start)
```

### Exercise 2

Copy/paste your code. The function `summarize()` is similar to `mutate()` but creates its new column in a summary table. Within the function `summarize()`, create a column named `mean_change` and set it to the `mean()` of `att_change`. 


```{r summarize-2, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy to use previous code</button>

```{r summarize-2-hint-1, eval = FALSE}
trains |> 
  mutate(att_change = att_end - att_start) |> 
  summarize(mean_change = mean(...))
```

### Exercise 3

Copy/paste your code before the summarize function, i.e. the code in Exercise 1. `summarize()` can create a tibble with more than one new column.  Within the function `summarize()`, create a column named `mean_change` and set it to the `mean()` of `att_change` and create a column named `max_change` and set it to the `max()` of `att_change`. 


```{r summarize-3, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy to use previous code</button>

```{r summarize-3-hint-1, eval = FALSE}
... |> 
  summarize(mean_change = mean(...), 
            max_change = max(...))
```

### 

`summarize()` must be piped directly after a tibble that has the data you want to summarize. Piping one `summarize()` function after another does not create a bigger `summarize()` table, but gives an error.

### Exercise 4

Copy/paste your code before the `summarize()` function. You can make summarize columns without assigning them names. Run the `summarize()` function with only the arguments, `mean(att_change)` and `max(att_change)`. 


```{r summarize-4, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy to use previous code</button>

```{r summarize-4-hint-1, eval = FALSE}
... |> 
  summarize(mean(...), 
            max(...))
```

### 

If no names are given, `summarize()` will simply use the arguments as names. 

### Exercise 5

`summarize()` is not limited to just summary functions. Start a new pipe with `trains`. Use `summarize()` to create tibble with two new columns: the first, `avg_hisp_perc_scaled` which is equal to the `mean()` value of `hisp_perc` times 100; the second, `median_hisp_perc_scaled` which is equal to the `median()` value of `hisp_perc` times 100. The results will be N/A because `hisp_perc` has missing values. 


```{r summarize-5, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy to use previous code</button>

```{r summarize-5-hint-1, eval = FALSE}
... |> 
  summarize(avg_hisp_perc_scaled = mean(hisp_perc) * ...,
            median_hisp_perc_scaled = median(hisp_perc) * ...)
```

### Exercise 6

Copy/paste the code above. Add `na.rm` in both the `median()` and `mean()` functions


```{r summarize-6, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy to use previous code</button>

```{r summarize-6-hint-1, eval = FALSE}
... |> 
  summarize(avg_hisp_perc_scaled = mean(hisp_perc, na.rm = TRUE) * ...,
            median_hisp_perc_scaled = median(hisp_perc, na.rm = TRUE) * ...) 
```

### Exercise 7

Start a new pipe with `trains`. Use `summarize()` to make a tibble with a new column called `ideology_quantiles` which contains the 1st, 50th, and 99th percentiles of `ideology_start`. 


```{r summarize-7, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy to use previous code</button>

```{r summarize-7-hint-1, eval = FALSE}
Remember to write probabilities in decimal form. 
```

```{r summarize-7-hint-2, eval = FALSE}
... |> 
  summarize(ideology_quantiles = quantile(ideology_start, 
                                          probs = c(..., ..., ...)))
```

### 

The summarize table should have three rows, the first corresponding to the first one of our percentiles, and so on. 

### Exercise 8

Though we know what percentiles we have calculated, this information is not in the tibble. Start a new pipe with `trains`. Use `summarize()` to make a tibble with two new columns: the first, `ideology_quantiles` which contains the 1st, 50th, and 99th percentiles of `ideology_start`; the second `percentiles` which is equal to the vector `c("1st", "50th", "99th")`.


```{r summarize-8, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy to use previous code</button>

```{r summarize-8-hint-1, eval = FALSE}
... |> 
  summarize(ideology_quantiles = quantile(ideology_start, 
                                          probs = c(..., ..., ...)),
            percentiles = c("...", "...", "..."))
```

### 

`summarize()`, like `mutate()`, can also create a new column which has nothing to do with the data, as we have done here with the `percentiles` column. 

### 

Good work. 

## `group_by()`
### 

More commonly, we |>  use `summarize()` to produce summary statistics not for the whole data, but for groups of data. You will practice doing this and also learn the importance of ungrouping in certain situations.

### Exercise 1

Run `trains` to view the tibble. 

```{r groupby-1, exercise = TRUE}

```

### 

Notice the box in the upper left-hand corner where the dimensions are displayed. 

### Exercise 2

Start a pipe with `trains`. Use the function `group_by()` with the argument `gender` to group the data by the column gender.


```{r groupby-2, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy to use previous code</button>

```{r groupby-2-hint-1, eval = FALSE}
... |> 
  group_by(gender)
```

### 

There should be no change to either the data or their order in the tibble. Note that next to the dimensions box, there is now a box telling us by what we have grouped by and how many groups it has created. 

### Exercise 3

Copy/paste your code. Use `summarize()` to make a tibble with two new columns: the first, `avg_att_start` which contains the `mean()` of `att_start`; the second, `avg_att_end` which contains the `mean()` of `att_end`. 


```{r groupby-3, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy to use previous code</button>

```{r groupby-3-hint-1, eval = FALSE}
... |>
  summarize(... = mean(att_start), 
            ... = mean(...))
```

### 

Because we have grouped by `gender`, we now have a tibble with two rows, one with the two averages for males and one for females. 

### Exercise 4

Start a new pipe with `trains`. Use `mutate()` to create a new column `big_hisp_perc` which returns `TRUE` when `hisp_perc` is greater than or equal to .04 and `FALSE` when it is not. 


```{r groupby-4, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy to use previous code</button>

```{r groupby-4-hint-1, eval = FALSE}
... |> 
  mutate(big_hisp_perc = if_else(hisp_perc > .04, TRUE, FALSE))
```

### Exercise 5

Continue your pipe and use `group_by()` to group the data by the columns `liberal` and `big_hisp_perc`. 


```{r groupby-5, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy to use previous code</button>

```{r groupby-5-hint-1, eval = FALSE}
... |> 
  group_by(liberal, big_hisp_perc)
```

### 

Note that the box in the upper right-hand corner shows that we have five groups instead of the expected 4. Can you guess why this is?

### Exercise 6

Copy/paste your code. Now use the function `summarize()` to make a tibble with two new columns:the first, `mean_att_start` which is equal to the `mean()` of the column `att_start`; the second, `max_att_start` which is equal to the `max()` of the same column.


```{r groupby-6, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy to use previous code</button>

```{r groupby-6-hint-1, eval = FALSE}
... |> 
  group_by(liberal, big_hisp_perc) |> 
  summarize(mean_att_start = mean(...), 
            max_att_start = max(...))
```

### 

Note that the tibble has all the expected groups, but also a group which has `N/A` for value `big_hisp_perc`. This is because there was one missing value for `hisp_perc`, which was assigned neither `TRUE` nor `FALSE` when we made `big_hisp_perc`. 

### Exercise 7

Copy/paste your code.  Use the function `drop_na()` with the column `big_hisp_perc` as its argument to remove all rows with a value of `N/A` in this column. 


```{r groupby-7, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy to use previous code</button>

```{r groupby-7-hint-1, eval = FALSE}
... |> 
  group_by(democrat, ...) |> 
  summarize(mean_change = mean(...), 
            max_change = max(...))|>
  drop_na()
```

```{r groupby-7-hint-2, eval = FALSE}
trains |> 
  mutate(big_hisp_perc = if_else(hisp_perc > .04, TRUE, FALSE))|>
  group_by(liberal, big_hisp_perc)|>
  summarize(mean_att_start = mean(att_start), 
            max_att_start = max(att_start))|>
              drop_na(big_hisp_perc)
```

### 

Note that `drop_na()` without an argument removes all rows containing values NA in any column from a tibble. 

### Exercise 8

Copy/paste your code. Use `arrange()` to arrange your summary table by `mean_att_start` in ascending order.


```{r groupby-8, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy to use previous code</button>

```{r groupby-8-hint-1, eval = FALSE}
... |> 
  arrange(mean_att_start)
```

### Exercise 9

Copy/paste your code before the current `summarize()` command, i.e. your code from Exercise 5 which ends with the `group_by()` command. Run `drop_na()` to get rid of N/A values in the tibble. Then, arrange this tibble by `att_start` in descending order. 


```{r groupby-9, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy to use previous code</button>

```{r groupby-9-hint-1, eval = FALSE}
... |> 
  arrange(desc(...))
```

```{r groupby-9-hint-2, eval = FALSE}
trains |> 
  mutate(big_hisp_perc = if_else(hisp_perc > .04, TRUE, FALSE))|>
  group_by(liberal, big_hisp_perc)|>
  drop_na()|>
  arrange(desc(att_start))
```

### Exercise 10

Copy/paste your code. Use `slice()` to keep only first 5 rows. When you run the code, however, you will get 20 rows. This is because the data was grouped, and so `slice()` made a tibble of the rows containing the 5 highest starting attitudes for each group. 


```{r groupby-10, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy to use previous code</button>

```{r groupby-10-hint-1, eval = FALSE}
... |> 
  slice(1:5)
```

### Exercise 11

Copy/paste your code before `slice()` function. To ungroup the table, continue your pipe and use the function `ungroup()`. Now  slice the first 5 rows. 


```{r groupby-11, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy to use previous code</button>

```{r groupby-11-hint-1, eval = FALSE}
... |> 
  ungroup() |> 
  slice(1:5)
```

### 

In addition to `summarize()` and `slice()`, `group_by()` also changes the behavior of `mutate()`. This use is similar to that with `summarize()` in that it allows for calculation among groups, but, unlike `summarize()` it does not remove rows or columns from the existing tibble. 


## Governors
### 

Let's create this graph using the functions we've just learned.

```{r}
gov_p <- governors |>
  select(state, election_age, party) |>
  filter(state == "Massachusetts") |>
  ggplot(aes(x = election_age, fill = party)) +
  geom_histogram(binwidth = 1,
                 color = "black") +
  facet_wrap(~party) +
  labs(title = "Histogram of Governors Elected in Massachusetts",
       subtitle = "Democrat Governors are generally younger than Republican Governors",
       x = "Age at Election",
       y = "Count",
       fill = "Party",
       caption = "Source: Barfort, Klemmensen & Larsen (2019)")

gov_p
```


### Exercise 1

Type `governors` to view the data set.

```{r governors-i-1, exercise = TRUE}

```

### 

The `governors` data set has 14 columns, starting with `state`, `year`, and `first_name`.

### Exercise 2

Select the columns `state`, `election_age` and `party`.

```{r governors-i-2, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r governors-i-2-hint-1, eval = FALSE}
governors |>
  select(..., ..., ...)
```

### 

Notice `<chr>`, `<dbl>` and `<chr>` below the names of the columns, these are called "vectors". There are six types of vector objects available in R: Logical vector, Numeric vector, Integer vector, Complex vector, Character vector, and Raw vector. We will explore these vectors in later chapters.

### Exercise 3

Filter for rows in which `state` is `"Massachusetts"`. Remember to use the `==` instead of `=`. otherwise R would returns an error message. 

```{r governors-i-3, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r governors-i-3-hint-1, eval = FALSE}
governors|>
  select(..., ..., ...) |>
  filter(state == "Massachusetts")
```

### Exercise 4

Continue your pipe and use `ggplot()`. Inside your aesthetic, map `election_age` to the x-axis and `party`  to `fill`. Also add the layer `geom_histogram()`.

```{r governors-i-4, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r governors-i-4-hint-1, eval = FALSE}
governors|>
  select(..., ..., ...) |>
  filter(state == "...") |>
  ggplot(mapping = aes(x = ...,
                       fill = ...)) +
  geom_historgram()
```

```{r governors-i-4-hint-2, eval = FALSE}
governors|>
  select(state, election_age, party) |>
  filter(state == "Massachusetts") |>
  ggplot(aes(x = election_age,
             fill = party)) +
  geom_histogram()
```

### 

You should have `election_age` on your x-axis, and `count` on your y-axis. Histograms (`geom_histogram()`) display the counts with bars; frequency polygons (`geom_freqpoly()`) display the counts with lines.

### Exercise 5

Copy/paste your code from above. Inside `geom_histogram()`, set `binwidth` to `1` and `color` to `"black"`.

```{r governors-i-5, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r governors-i-5-hint-1, eval = FALSE}
governors|>
  select(state, election_age, party)|>
  filter(state == "Massachusetts") |>
  ggplot(aes(x = election_age,
             fill = party)) +
  geom_histogram(binwidth = ...)
```

### 

This should remove the message "`stat_bin()` using `bins = 30`. Pick better value with `binwidth`" once you have run your code chunk. 

### Exercise 6

Add black line borders demarcating the bins by setting the argument `color` to `"black"` within `geom_histogram()`.

```{r governors-i-6, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r governors-i-6-hint-1, eval = FALSE}
governors|>
  select(state, election_age, party) |>
  filter(state == "Massachusetts") |>
  ggplot(aes(x = election_age,
             fill = party)) +
  geom_histogram(binwidth = ...,
                 color = "...")
```

### Exercise 7

Add the layer `facet_wrap()` and facet by the variable `party`.

```{r governors-i-7, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r governors-i-7-hint-1, eval = FALSE}
... + 
  facet_wrap( ~ ...)
```

```{r governors-i-7-hint-2, eval = FALSE}
... + 
  facet_wrap( ~party)
```

### 

You can also replace `~party` with `vars(party)`, the resulting graph should look the same. 


### Exercise 8

To finish your plot, use `labs()` to give the graph a title, subtitle, axes labels, legend labels,  and caption of your choosing.

Reminder: This is what your plot should look like.

```{r}
gov_p
```

```{r governors-i-8, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r governors-i-8-hint-1, eval = FALSE}
... +
  labs(title = "...",
       subtitle = "..."
       x = "...",
       y = "...",
       fill = "..."
       caption = "...")
```

### 

By how much the Democrat Governors are younger than the Republican Governors? Proceed to the following exercises to find out.



### Exercise 9

Again, start a pipe with `governors`, and select the columns `state`, `election_age` and `party`.

```{r governors-i-9, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r governors-i-9-hint-1, eval = FALSE}
governors|>
  select(state,election_age,party) |>
  filter(state == "Massachusetts")
```

### Exercise 10

Filter for rows in which `state` is `"Massachusetts"`. 

```{r governors-i-10, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r governors-i-10-hint-1, eval = FALSE}
governors|>
  select(..., ..., ...) |>
  filter(state == "Massachusetts")
```

### Exercise 11

Continue your pipe, use `group_by()` to create a group based on `party`.
```{r governors-i-11, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>

```{r governors-i-11-hint-1, eval = FALSE}
governors|>
  select(..., ..., ...) |>
  filter(state == "Massachusetts") |>
  group_by(...)
```

```{r governors-i-11-hint-2, eval = FALSE}
governors|>
  select(..., ..., ...) |>
  filter(state == "Massachusetts") |>
  group_by(party)
```

### Exercise 12

Then use `summarize()` to create a new variable `avg_age` which is equal to the `mean()` of `election_age`.
```{r governors-i-12, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>


```{r governors-i-12-hint-1, eval = FALSE}
governors|>
  select(..., ..., ...) |>
  filter(state == "...") |>
  group_by(...)|>
  summarize(avg_age = mean(...))

```

```{r governors-i-12-hint-2, eval = FALSE}
governors |>
  select(state,election_age,party) |>
  filter(state == "Massachusetts") |>
  group_by(party)|>
  summarize(avg_age = mean(election_age))

```

### Exercise 13

To find the difference, use `summarize()` again to create a new variable `age_diff` which is equal to the `diff()` of `avg_age`.
```{r governors-i-13, exercise = TRUE}

```

<button onclick = "transfer_code(this)">Copy previous code</button>


```{r governors-i-13-hint-1, eval = FALSE}
governors|>
  select(..., ..., ...) |>
  filter(state == "...") |>
  group_by(...) |>
  summarize(avg_age = mean(...)) |>
  summarize(age_diff = diff(...))

```

```{r governors-i-13-hint-2, eval = FALSE}
governors|>
  select(state,election_age,party) |>
  filter(state == "Massachusetts") |>
  group_by(party) |>
  summarize(avg_age = mean(election_age)) |>
  summarize(age_diff = diff(avg_age))
```

### 

The `diff()` function takes the value of the nth row and subtract that from the (n+1)th row. 

### Exercise 14

Write a short statement about your findings in the above exercise.

```{r governors-i-14}
question_text(NULL,
	message = "On average, the Democrat Governors in Massachusetts are 6.48 years younger than the Republican Governors.",
	answer(NULL,
	correct = TRUE),
	allow_retry = FALSE,
	incorrect = NULL,
	rows = 6)
```

### 

Good work.



```{r include = FALSE}
# Consider Including
governors|>
  select(state,election_age,party)|>
  filter(state == "Massachusetts")|>
  group_by(party)|>
  summarize(avg_age = mean(election_age))

governors|>
  select(state,election_age,party)|>
  filter(party == "Democrat"|party == "Republican")|>
  group_by(state,party)|>
  summarize(avg_age = mean(election_age),.groups = 'drop')|>
  group_by(state)|>
  summarize(diff_age = diff(avg_age))|>
  arrange(diff_age)
```

## Summary
### 

<!-- Yuhan: Need Grammar review.  -->

Great job, you have just familiarize yourself with the tools that are essential to deal with data. These functions often look simple but are strong enough to handle almost all data sets with the help of several other functions. These functions you've learned in this chapter will becomes your friend in your exploration of R and data science. Good luck!

```{r download-answers, child = "../../child_documents/download_answers.Rmd"}
```
