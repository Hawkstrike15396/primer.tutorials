# Read the R-CMD-check yaml file.
# The workflow will run on a push or pull request.
on:
  push:
  pull_request:

name: pkgdown

jobs:
  pkgdown:
    # Again, ubuntu seems to work better.
    runs-on: ubuntu-latest
    env:
      # Forces binary.
      R_COMPILE_AND_INSTALL_PACKAGES: never
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
      # Census api key not working in github, not sure why
      CENSUS_API_KEY: ${{ secrets.CENSUS_KEY }}
      R_LIBS_USER: ~/Library/Application Support/renv
      # This variable improves workflow, not sure why; do some research!
      R_KEEP_PKG_SOURCE: yes
    steps:
      # Again, visit the following link for information on these setups.
      # https://github.com/r-lib/actions
      - uses: actions/checkout@v2
      - uses: r-lib/actions/setup-r@master
      - uses: r-lib/actions/setup-pandoc@master
      - uses: r-lib/actions/setup-r-dependencies@v2
      - uses: r-lib/actions/setup-r@v2
      - uses: r-lib/actions/setup-renv@v2
      # Finds all necessary dependencies and sees if they are ahead 
      # or behind CRAN. 
      # Not sure if this necessary, feel free to experiment with it.
      - name: Query dependencies
        run: |
          install.packages('remotes')
          saveRDS(remotes::dev_package_deps(dependencies = TRUE), ".github/depends.Rds", version = 2)
        shell: Rscript {0}
      # Installs R CMD check stuff
      - name: Install package
        run: R CMD INSTALL .
      # Establishes preceptors github credentials for workflow
      - name: Establish git credentials
        run: |
          install.packages("usethis")
          usethis::use_git_config(user.name = "David Kane", user.email = "dave.kane@gmail.com")
        shell: Rscript {0}
      # A way to customize our site, see following link.
      # https://pkgdown.r-lib.org/reference/deploy_to_branch.html
      - name: Deploy package
        run: pkgdown::deploy_to_branch(new_process = FALSE)
        shell: Rscript {0}
